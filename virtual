#!/bin/bash

# Installer LXC Legacy Script Environment untuk Ubuntu 24.04 (Host)
# Container: Ubuntu 20.04 (Focal Fossa) - Versi Final

# Fungsi untuk menampilkan pesan status
function status_msg {
    echo -e "\n\033[1;32m==>\033[0m \033[1;37m$1\033[0m"
}

# Fungsi untuk menampilkan pesan error
function error_msg {
    echo -e "\n\033[1;31m==> ERROR:\033[0m \033[1;37m$1\033[0m"
}

# Cek apakah script dijalankan sebagai root
if [ "$(id -u)" -ne 0 ]; then
    error_msg "Script ini harus dijalankan sebagai root atau dengan sudo!"
    exit 1
fi

status_msg "Memulai instalasi LXC Legacy Script Environment (Ubuntu 20.04)..."

# Update sistem
status_msg "Memperbarui paket sistem..."
apt update && apt upgrade -y

# Install LXC dan dependensi
status_msg "Menginstall LXC dan dependensi yang diperlukan..."
apt install -y lxc lxc-templates bridge-utils uidmap snapd

# Install LXD melalui snap
status_msg "Menginstall LXD melalui snap..."
snap install lxd --channel=latest/stable
snap refresh lxd

# Inisialisasi LXD
status_msg "Melakukan inisialisasi LXD..."
lxd init --auto

# Konfigurasi subuid/subgid
status_msg "Mengkonfigurasi LXC..."
echo "root:100000:65536" | tee -a /etc/subuid /etc/subgid

# Tambahkan remote Ubuntu yang kompatibel
status_msg "Menambahkan remote image yang kompatibel..."
lxc remote add ubuntu-old https://cloud-images.ubuntu.com/releases/ --protocol simplestreams

# Buat container legacy-script-env
status_msg "Membuat container legacy-script-env dengan Ubuntu 20.04..."

# Hapus container jika sudah ada
if lxc list | grep -q "legacy-script-env"; then
    status_msg "Menghapus container yang sudah ada..."
    lxc stop legacy-script-env --force
    lxc delete legacy-script-env
fi

# Buat container baru dari image yang valid
status_msg "Mendownload image Ubuntu 20.04 yang valid..."
lxc launch ubuntu-old:20.04 legacy-script-env

# Tunggu container mulai
status_msg "Menunggu container mulai..."
while ! lxc list | grep -q "legacy-script-env.*RUNNING"; do
    echo "Menunggu container mulai..."
    sleep 5
done

# Setup dasar di dalam container
status_msg "Menyiapkan environment di dalam container..."
lxc exec legacy-script-env -- bash -c "apt update && apt upgrade -y"
lxc exec legacy-script-env -- bash -c "apt install -y sudo curl wget nano gnupg2 software-properties-common"

# Buat user dengan sudo privileges di dalam container
status_msg "Membuat user di dalam container..."
lxc exec legacy-script-env -- bash -c "useradd -m -s /bin/bash user && echo 'user:userpass' | chpasswd"
lxc exec legacy-script-env -- bash -c "usermod -aG sudo user"

# Buat alias untuk masuk/keluar container
status_msg "Membuat alias untuk memudahkan akses container..."
echo -e '\nalias virtual="lxc exec legacy-script-env -- bash"' >> ~/.bashrc
echo -e 'alias root="exit"' >> ~/.bashrc
echo -e 'alias container="lxc exec legacy-script-env -- sudo -u user -i"' >> ~/.bashrc

# Aktifkan alias tanpa perlu restart terminal
source ~/.bashrc

# Informasi selesai
status_msg "Instalasi selesai!"
echo -e "\n\033[1;33mPERHATIAN:\033[0m Jika Anda menggunakan ZSH, tambahkan alias ke ~/.zshrc juga\n"
echo -e "Anda sekarang dapat menggunakan perintah berikut:"
echo -e "  - \033[1;36mvirtual\033[0m   : Untuk masuk ke dalam container sebagai root"
echo -e "  - \033[1;36mcontainer\033[0m : Untuk masuk ke dalam container sebagai user"
echo -e "  - \033[1;36mroot\033[0m      : Untuk keluar dari container\n"
echo -e "Perintah tambahan:"
echo -e "  - \033[1;36mlxc list\033[0m  : Untuk melihat daftar container"
echo -e "  - \033[1;36mlxc stop legacy-script-env\033[0m : Untuk menghentikan container"
echo -e "  - \033[1;36mlxc start legacy-script-env\033[0m : Untuk memulai container\n"

# Verifikasi container
status_msg "Verifikasi container..."
lxc list

# Masuk ke container
read -p "Masuk ke container sekarang? (y/n) " choice
if [[ "$choice" =~ [yY] ]]; then
    lxc exec legacy-script-env -- bash
fi
