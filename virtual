#!/bin/bash

# ==============================================
# VPN CONTAINER FIXER SCRIPT
# ==============================================

CONTAINER_NAME="vpn-container"
CONTAINER_IMAGE="ubuntu:20.04"

# Fungsi untuk menampilkan pesan
function show_msg() {
    echo -e "\033[1;36m>>> $1\033[0m"
}

function show_error() {
    echo -e "\033[1;31m!!! $1\033[0m"
}

function show_success() {
    echo -e "\033[1;32mâœ“ $1\033[0m"
}

# 1. Perbaikan LXD
function fix_lxd() {
    show_msg "Memperbaiki instalasi LXD..."
    
    # Pastikan snap path ada
    export PATH=$PATH:/snap/bin
    echo 'export PATH=$PATH:/snap/bin' >> ~/.bashrc
    
    # Perbaikan group
    sudo usermod -aG lxd $USER
    newgrp lxd
    
    # Inisialisasi ulang LXD jika perlu
    if ! lxc network list | grep -q lxdbr0; then
        show_msg "Menginisialisasi LXD..."
        cat <<EOF | lxd init --preseed
config:
  core.https_address: '[::]:8443'
storage_pools:
- name: default
  driver: dir
networks:
- name: lxdbr0
  type: bridge
profiles:
- name: default
  devices:
    root:
      path: /
      pool: default
      type: disk
    eth0:
      name: eth0
      network: lxdbr0
      type: nic
EOF
    fi
}

# 2. Buat container jika belum ada
function create_container() {
    show_msg "Membuat container $CONTAINER_NAME..."
    
    # Hapus container lama jika ada
    if lxc list --format csv | grep -q "^$CONTAINER_NAME,"; then
        show_msg "Menghapus container lama..."
        lxc delete $CONTAINER_NAME --force
    fi
    
    # Buat container baru
    lxc launch $CONTAINER_IMAGE $CONTAINER_NAME
    
    # Konfigurasi container
    lxc config set $CONTAINER_NAME security.nesting true
    lxc config set $CONTAINER_NAME security.privileged true
    lxc config set $CONTAINER_NAME limits.memory 2GB
    lxc config set $CONTAINER_NAME limits.cpu 2
    
    # Tunggu container siap
    show_msg "Menunggu container siap..."
    sleep 15
    lxc exec $CONTAINER_NAME -- cloud-init status --wait
    
    # Verifikasi
    if ! lxc list | grep -q "$CONTAINER_NAME.*RUNNING"; then
        lxc start $CONTAINER_NAME
        sleep 5
    fi
}

# 3. Perbaikan menu
function fix_menu() {
    show_msg "Memperbaiki menu akses..."
    
    # Buat script menu baru
    sudo tee /usr/local/bin/vpn-menu > /dev/null <<'EOL'
#!/bin/bash

CONTAINER_NAME="vpn-container"

# Cek apakah container ada
if ! lxc list --format csv | grep -q "^$CONTAINER_NAME,"; then
    echo "Container $CONTAINER_NAME tidak ditemukan, membuat baru..."
    sudo lxc launch ubuntu:20.04 $CONTAINER_NAME
    sudo lxc config set $CONTAINER_NAME security.nesting true
    sudo lxc config set $CONTAINER_NAME security.privileged true
    sleep 10
fi

# Start container jika belum running
if [ "$(lxc list -f csv | grep "^$CONTAINER_NAME," | cut -d, -f4)" != "RUNNING" ]; then
    echo "Menjalankan container $CONTAINER_NAME..."
    lxc start $CONTAINER_NAME
    sleep 5
fi

echo "Memasuki container $CONTAINER_NAME..."
exec lxc exec $CONTAINER_NAME -- bash
EOL

    sudo chmod +x /usr/local/bin/vpn-menu
    
    # Update alias
    echo "alias menu='vpn-menu'" >> ~/.bashrc
    source ~/.bashrc
}

# Main process
show_msg "Memulai proses perbaikan..."

# Jalankan perbaikan
fix_lxd
create_container
fix_menu

# Verifikasi akhir
if lxc list --format csv | grep -q "^$CONTAINER_NAME,RUNNING"; then
    show_success "PERBAIKAN BERHASIL!"
    echo -e "\nSekarang Anda bisa menggunakan:"
    echo -e "  \033[1;32mmenu\033[0m - Untuk masuk ke container"
else
    show_error "Perbaikan gagal. Coba langkah manual:"
    echo "1. Buat container manual:"
    echo "   lxc launch ubuntu:20.04 vpn-container"
    echo "2. Konfigurasi:"
    echo "   lxc config set vpn-container security.nesting true"
    echo "3. Coba akses:"
    echo "   lxc exec vpn-container -- bash"
fi
