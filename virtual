#!/bin/bash

# ==============================================
# VPN CONTAINER INSTALLER - FINAL FIXED VERSION
# ==============================================

CONTAINER_NAME="vpn-container"
CONTAINER_IMAGE="ubuntu:20.04"
LXD_CHANNEL="latest/stable"

# Fungsi untuk menampilkan pesan
function show_msg() {
    echo -e "\033[1;36m>>> $1\033[0m"
}

function show_error() {
    echo -e "\033[1;31m!!! $1\033[0m"
}

function show_success() {
    echo -e "\033[1;32mâœ“ $1\033[0m"
}

# 1. Persiapan sistem
function system_prep() {
    show_msg "Memulai persiapan sistem..."
    
    # Update dan upgrade sistem
    sudo apt update
    sudo apt upgrade -y
    
    # Install dependensi
    sudo apt install -y snapd zfsutils-linux bridge-utils
    
    # Aktifkan snapd
    sudo systemctl enable --now snapd.socket
}

# 2. Install dan konfigurasi LXD
function install_lxd() {
    show_msg "Menginstal LXD..."
    
    # Hapus instalasi lama
    sudo snap remove --purge lxd 2>/dev/null
    sudo apt remove --purge lxd lxd-client 2>/dev/null
    sudo rm -rf /var/snap/lxd
    sudo rm -rf /var/lib/lxd
    
    # Install LXD via snap
    sudo snap install lxd --channel=$LXD_CHANNER
    
    # Tambahkan path snap
    export PATH=$PATH:/snap/bin
    echo 'export PATH=$PATH:/snap/bin' >> ~/.bashrc
    source ~/.bashrc
    
    # Setup grup
    sudo usermod -aG lxd $USER
    newgrp lxd
    
    # Inisialisasi LXD dengan storage pool yang benar
    show_msg "Menginisialisasi LXD..."
    cat <<EOF | lxd init --preseed
config:
  core.https_address: '[::]:8443'
  core.trust_password: ""
  images.auto_update_interval: 24
storage_pools:
- name: default
  driver: zfs
  config:
    source: /var/lib/lxd/storage-pools/default
    zfs.pool_name: default
networks:
- name: lxdbr0
  type: bridge
  config:
    ipv4.address: auto
    ipv6.address: none
profiles:
- name: default
  devices:
    root:
      path: /
      pool: default
      type: disk
    eth0:
      name: eth0
      network: lxdbr0
      type: nic
EOF
}

# 3. Buat dan konfigurasi container
function setup_container() {
    show_msg "Membuat container $CONTAINER_NAME..."
    
    # Hapus container lama jika ada
    if lxc list --format csv | grep -q "^$CONTAINER_NAME,"; then
        show_msg "Menghapus container lama..."
        lxc delete $CONTAINER_NAME --force
    fi
    
    # Pastikan storage pool ada
    if ! lxc storage list --format csv | grep -q "^default,"; then
        show_msg "Membuat storage pool default..."
        lxc storage create default zfs source=/var/lib/lxd/storage-pools/default
    fi
    
    # Buat container baru dengan konfigurasi eksplisit
    show_msg "Membuat container baru..."
    lxc init $CONTAINER_IMAGE $CONTAINER_NAME -c security.nesting=true -c security.privileged=true
    
    # Attach storage secara manual
    lxc config device add $CONTAINER_NAME root disk path=/ pool=default
    
    # Konfigurasi resource
    lxc config set $CONTAINER_NAME limits.memory 2GB
    lxc config set $CONTAINER_NAME limits.cpu 2
    
    # Mulai container
    lxc start $CONTAINER_NAME
    
    # Tunggu container siap
    show_msg "Menunggu container siap..."
    sleep 15
    lxc exec $CONTAINER_NAME -- cloud-init status --wait
}

# 4. Setup menu akses
function setup_menu() {
    show_msg "Membuat menu akses container..."
    
    # Buat script menu yang lebih robust
    sudo tee /usr/local/bin/vpn-menu > /dev/null <<'EOL'
#!/bin/bash

CONTAINER_NAME="vpn-container"

# Fix permission warning
unset XDG_RUNTIME_DIR

# Cek apakah container ada
if ! lxc list --format csv | grep -q "^$CONTAINER_NAME,"; then
    echo "Container $CONTAINER_NAME tidak ditemukan, membuat baru..."
    sudo lxc init ubuntu:20.04 $CONTAINER_NAME -c security.nesting=true -c security.privileged=true
    sudo lxc config device add $CONTAINER_NAME root disk path=/ pool=default
    sudo lxc start $CONTAINER_NAME
    sleep 15
fi

# Start container jika belum running
CONTAINER_STATUS=$(lxc list -f csv | grep "^$CONTAINER_NAME," | cut -d, -f4)
if [ "$CONTAINER_STATUS" != "RUNNING" ]; then
    echo "Menjalankan container $CONTAINER_NAME..."
    sudo lxc start $CONTAINER_NAME
    sleep 5
fi

echo "Memasuki container $CONTAINER_NAME..."
exec sudo lxc exec $CONTAINER_NAME -- bash
EOL

    sudo chmod +x /usr/local/bin/vpn-menu
    
    # Buat alias
    if ! grep -q "alias menu=" ~/.bashrc; then
        echo "alias menu='vpn-menu'" >> ~/.bashrc
    fi
    
    source ~/.bashrc
}

# 5. Fix permission issues
function fix_permissions() {
    show_msg "Memperbaiki permission issues..."
    
    # Fix permission warning
    echo "unset XDG_RUNTIME_DIR" >> ~/.bashrc
    
    # Rebuild group cache
    sudo gpasswd -a $USER lxd
    newgrp lxd
    sudo systemctl restart snap.lxd.daemon
}

# Main installation
show_msg "Memulai instalasi VPN Container..."

# Jalankan semua fungsi
system_prep
install_lxd
setup_container
fix_permissions
setup_menu

# Verifikasi akhir
if lxc list --format csv | grep -q "^$CONTAINER_NAME,RUNNING"; then
    show_success "INSTALASI BERHASIL!"
    echo -e "\nSekarang Anda bisa menggunakan:"
    echo -e "  \033[1;32mmenu\033[0m       - Untuk masuk ke container"
    echo -e "  \033[1;32mlxc list\033[0m   - Untuk melihat daftar container"
    echo -e "\nCukup ketik 'menu' untuk masuk ke container VPN"
else
    show_error "Instalasi gagal. Silakan coba langkah berikut:"
    echo "1. Jalankan installer lagi:"
    echo "   sudo $(readlink -f "$0")"
    echo "2. Atau coba buat container manual:"
    echo "   lxc init ubuntu:20.04 $CONTAINER_NAME"
    echo "   lxc config device add $CONTAINER_NAME root disk path=/ pool=default"
    exit 1
fi
