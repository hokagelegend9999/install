#!/bin/bash

# =============================================
# INSTALLER LXC UBUNTU 20.04 - VERSI DEFINITIF
# =============================================

# Fungsi untuk tampilan
function show_msg() {
    echo -e "\n\e[1;34m>>\e[0m \e[1;37m$1\e[0m"
}

function show_error() {
    echo -e "\n\e[1;31mERROR:\e[0m \e[1;37m$1\e[0m"
}

function show_success() {
    echo -e "\e[1;32mâœ“\e[0m $1"
}

# Cek root
if [ "$(id -u)" -ne 0 ]; then
    show_error "Script harus dijalankan sebagai root!"
    exit 1
fi

# 1. Install LXD via Snap
show_msg "1. Menginstall LXD..."
if ! command -v lxd &> /dev/null; then
    snap install lxd --channel=latest/stable
    snap refresh lxd
else
    show_success "LXD sudah terinstall"
fi

# 2. Inisialisasi LXD
show_msg "2. Inisialisasi LXD..."
lxd init --auto

# 3. Setup Container
show_msg "3. Membuat Container Ubuntu 20.04..."
lxc remote add ubuntu-legacy https://cloud-images.ubuntu.com/releases --protocol simplestreams

if lxc list | grep -q "legacy-script-env"; then
    show_msg "Menghapus container lama..."
    lxc stop legacy-script-env --force
    lxc delete legacy-script-env
fi

lxc launch ubuntu-legacy:20.04 legacy-script-env

# 4. Konfigurasi Container
show_msg "4. Konfigurasi Environment..."
lxc exec legacy-script-env -- bash -c "apt update && apt upgrade -y"
lxc exec legacy-script-env -- bash -c "apt install -y sudo curl wget nano"

# 5. Buat User
show_msg "5. Membuat User..."
lxc exec legacy-script-env -- bash -c "useradd -m -s /bin/bash scriptuser && echo 'scriptuser:password' | chpasswd"
lxc exec legacy-script-env -- bash -c "usermod -aG sudo scriptuser"

# 6. Setup Alias di Host
show_msg "6. Membuat Alias..."
cat <<EOF >> /root/.bashrc

# LXC Aliases
alias virtual='lxc exec legacy-script-env -- bash'
alias lxc-user='lxc exec legacy-script-env -- sudo -u scriptuser -i'
alias lxc-stop='lxc stop legacy-script-env'
alias lxc-start='lxc start legacy-script-env'
alias lxc-list='lxc list'
EOF

# 7. Reload Bashrc
source /root/.bashrc

# 8. Selesai
show_msg "Instalasi Selesai!"
echo -e "\n\e[1;32mPERINTAH:\e[0m"
echo -e "  \e[1;36mvirtual\e[0m    - Masuk ke container"
echo -e "  \e[1;36mexit\e[0m       - Keluar dari container"
echo -e "\n\e[1;33mJalankan perintah ini jika alias tidak bekerja:\e[0m"
echo -e "  \e[1;36msource /root/.bashrc\e[0m"

# Masuk otomatis
read -p $'\nMasuk ke container sekarang? (y/n) ' -n 1 -r
if [[ $REPLY =~ ^[Yy]$ ]]; then
    lxc exec legacy-script-env -- bash
fi
