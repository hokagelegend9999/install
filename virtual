#!/bin/bash

# ==============================================
# Script Instalasi Container LXD untuk VPN Services
# Dengan Fitur Menu Masuk/Keluar Container
# ==============================================

# Fungsi untuk menampilkan pesan status
function status_msg() {
    echo -e "\n\033[1;32m>>> $1\033[0m\n"
}

# Fungsi untuk menampilkan pesan error
function error_msg() {
    echo -e "\n\033[1;31m!!! $1\033[0m\n"
}

# 1. Install LXD jika belum terinstall
status_msg "1. Memeriksa dan menginstall LXD..."
if ! command -v lxd &> /dev/null; then
    sudo apt update
    sudo apt install -y lxd
    sudo lxd init --minimal
else
    echo "LXD sudah terinstall, melanjutkan..."
fi

# 2. Membuat container
CONTAINER_NAME="vpn-container"
status_msg "2. Membuat container Ubuntu 20.04 ($CONTAINER_NAME)..."
lxc launch ubuntu:20.04 $CONTAINER_NAME

# 3. Menunggu container siap
status_msg "3. Menunggu container siap..."
sleep 10

# 4. Konfigurasi dasar container
status_msg "4. Konfigurasi dasar container..."
lxc exec $CONTAINER_NAME -- bash -c "apt update && apt upgrade -y"
lxc exec $CONTAINER_NAME -- bash -c "apt install -y wget curl nano iptables net-tools"

# 5. Setup port forwarding
status_msg "5. Setup port forwarding..."

# Xray ports (sesuaikan dengan kebutuhan)
lxc config device add $CONTAINER_NAME xray-http proxy listen=tcp:0.0.0.0:80 connect=tcp:127.0.0.1:80
lxc config device add $CONTAINER_NAME xray-ssl proxy listen=tcp:0.0.0.0:443 connect=tcp:127.0.0.1:443

# SSHWS port
lxc config device add $CONTAINER_NAME sshws proxy listen=tcp:0.0.0.0:2222 connect=tcp:127.0.0.1:2222

# Dropbear port
lxc config device add $CONTAINER_NAME dropbear proxy listen=tcp:0.0.0.0:109 connect=tcp:127.0.0.1:109

# PPTP port
lxc config device add $CONTAINER_NAME pptp proxy listen=tcp:0.0.0.0:1723 connect=tcp:127.0.0.1:1723

# L2TP port (UDP)
lxc config device add $CONTAINER_NAME l2tp-udp proxy listen=udp:0.0.0.0:1701 connect=udp:127.0.0.1:1701

# 6. Konfigurasi network tambahan
status_msg "6. Konfigurasi network container..."
lxc config device set $CONTAINER_NAME eth0 security.ipv4_filtering=false
lxc config device set $CONTAINER_NAME eth0 security.ipv6_filtering=false

# 7. Membuat direktori untuk script
status_msg "7. Membuat direktori untuk script di container..."
lxc exec $CONTAINER_NAME -- mkdir -p /root/vpn-scripts

# 8. Setup fungsi menu di .bashrc
status_msg "8. Setup fungsi menu di .bashrc..."

# Backup .bashrc
cp ~/.bashrc ~/.bashrc.bak

# Tambahkan fungsi menu
cat << 'EOF' >> ~/.bashrc

# ==============================================
# Fungsi untuk container LXD $CONTAINER_NAME
# ==============================================
function menu() {
    # Cek apakah container ada
    if ! lxc list | grep -q "$CONTAINER_NAME"; then
        echo "Container $CONTAINER_NAME tidak ditemukan!"
        return 1
    fi
    
    # Cek status container
    CONTAINER_STATUS=$(lxc list "$CONTAINER_NAME" -c s --format=csv)
    
    if [ "$CONTAINER_STATUS" != "RUNNING" ]; then
        echo "Container tidak berjalan, menjalankan container..."
        lxc start "$CONTAINER_NAME"
        sleep 3  # Tunggu container boot
    fi
    
    if [ -z "$LXD_CONTAINER_ACTIVE" ]; then
        echo "Memasuki container $CONTAINER_NAME..."
        export LXD_CONTAINER_ACTIVE=1
        export PS1="(container:$CONTAINER_NAME) $PS1"  # Tambah penanda di prompt
        lxc exec "$CONTAINER_NAME" -- /bin/bash
        unset LXD_CONTAINER_ACTIVE
        export PS1=${PS1#"(container:$CONTAINER_NAME) "}  # Hapus penanda
    else
        echo "Anda sudah berada dalam container. Ketik 'exit' untuk keluar."
    fi
}

alias masukcontainer='menu'
EOF

# 9. Load .bashrc
source ~/.bashrc

# 10. Informasi final
status_msg "9. Instalasi selesai!"
echo -e "\n\033[1;32mCONTAINER VPN BERHASIL DIBUAT!\033[0m"
echo -e "Container Name: \033[1;34m$CONTAINER_NAME\033[0m"
echo -e "Port Forwarding:"
echo -e " - Xray: 80, 443/tcp"
echo -e " - SSHWS: 2222/tcp"
echo -e " - Dropbear: 109/tcp"
echo -e " - PPTP: 1723/tcp"
echo -e " - L2TP: 1701/udp"

echo -e "\n\033[1;33mPERINTAH PENGGUNAAN:\033[0m"
echo -e "1. Untuk masuk ke container:"
echo -e "   \033[1;35mmenu\033[0m atau \033[1;35mmasukcontainer\033[0m"
echo -e "2. Untuk keluar dari container:"
echo -e "   \033[1;35mexit\033[0m"
echo -e "3. Untuk transfer script ke container:"
echo -e "   \033[1;35mlxc file push <file> $CONTAINER_NAME/root/vpn-scripts/\033[0m"
echo -e "4. Verifikasi port forwarding:"
echo -e "   \033[1;35msudo netstat -tulnp | grep lxd\033[0m"

echo -e "\n\033[1;32mSISTEM SIAP DIGUNAKAN!\033[0m"
