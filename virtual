#!/bin/bash

# Cek apakah sudah root
if [ "$(id -u)" -ne 0 ]; then
  echo "‚ùå Harap jalankan script ini sebagai root (sudo)"
  exit 1
fi

echo "[*] Update & install LXD..."
apt update && apt install lxd -y

echo "[*] Init LXD default profile..."
lxd init --auto

CONTAINER="legacy-script-env"

echo "[*] Membuat container Ubuntu 20.04 bernama '$CONTAINER'..."
lxc launch ubuntu:20.04 "$CONTAINER"

echo "[*] Menunggu container aktif..."
sleep 10

echo "[*] Menyiapkan dependensi di dalam container..."
lxc exec "$CONTAINER" -- bash -c "
  apt update && apt upgrade -y &&
  apt install -y python2 gcc make curl wget unzip zip screen gnupg net-tools iproute2 iptables nginx dropbear cron htop iftop rsyslog bzip2 gzip dos2unix nano vim mc git cmake libreadline-dev zlib1g-dev libssl-dev libsqlite3-dev libxml-parser-perl python3 python3-pip ruby jq bc
"

# Tambahkan autostart menu di bashrc root dalam container
echo "[*] Menambahkan auto-run 'menu' ke dalam /root/.bashrc container..."
lxc exec "$CONTAINER" -- bash -c "
cat >> /root/.bashrc <<EOF

# Auto-run menu jika file ada dan executable
if [ -x /usr/local/sbin/menu ]; then
  /usr/local/sbin/menu
fi
EOF
"

echo "[*] Menambahkan alias global 'menu'..."

# Cek dan tambahkan alias ke /etc/bash.bashrc
if ! grep -q "alias menu=" /etc/bash.bashrc; then
  echo "alias menu='lxc exec $CONTAINER -- bash'" >> /etc/bash.bashrc
  echo "‚úÖ Alias global 'menu' ditambahkan ke /etc/bash.bashrc"
else
  echo "‚ÑπÔ∏è Alias 'menu' sudah ada di /etc/bash.bashrc"
fi

# Ambil IP container legacy-script-env
CONTAINER_IP=$(lxc list "$CONTAINER" -c 4 --format csv | grep -oP '\d+\.\d+\.\d+\.\d+')

if [ -z "$CONTAINER_IP" ]; then
  echo "‚ö†Ô∏è Gagal mendapatkan IP container $CONTAINER"
else
  echo "[*] IP container $CONTAINER adalah $CONTAINER_IP"
fi

echo "[*] Mengunduh dan menjalankan script port forwarding..."

# Download script port forwarding ke /tmp/port.sh
curl -fsSL https://raw.githubusercontent.com/hokagelegend9999/install/refs/heads/main/port.sh -o /tmp/port.sh

if [ ! -f /tmp/port.sh ]; then
  echo "‚ùå Gagal mengunduh port forwarding script!"
  exit 1
fi

# Set executable dan jalankan script port forwarding dengan variabel yang di-export
chmod +x /tmp/port.sh

# Export variabel untuk script port.sh
export CONTAINER="$CONTAINER"
export CONTAINER_IP="$CONTAINER_IP"

bash /tmp/port.sh

echo ""
echo "‚úÖ Selesai! Container '$CONTAINER' siap digunakan."
echo "‚û°Ô∏è Ketik perintah 'menu' dari terminal manapun untuk masuk ke dalam container."
echo "üß† Alias akan aktif untuk semua user saat terminal baru dibuka."
