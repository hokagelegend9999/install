#!/bin/bash

# ==============================================
# VPN CONTAINER MANAGEMENT SCRIPT - FINAL FIXED VERSION
# ==============================================

CONTAINER_NAME="vpn-container"
CONTAINER_IMAGE="ubuntu:20.04"

# Fungsi untuk menampilkan pesan
function show_msg() {
    echo -e "\033[1;36m>>> $1\033[0m"
}

function show_error() {
    echo -e "\033[1;31m!!! $1\033[0m"
}

function show_success() {
    echo -e "\033[1;32mâœ“ $1\033[0m"
}

# 1. Setup LXD dan storage pool
function setup_lxd() {
    if ! command -v lxd &> /dev/null; then
        show_msg "Menginstall LXD..."
        sudo apt update
        sudo apt install -y lxd lxd-client zfsutils-linux
        sudo usermod -aG lxd $USER
        newgrp lxd
    fi

    # Pastikan storage pool 'default' ada
    if ! lxc storage list --format csv | grep -q "^default,"; then
        show_msg "Membuat storage pool default..."
        sudo mkdir -p /var/lib/lxd/storage-pools/default
        lxc storage create default dir source=/var/lib/lxd/storage-pools/default
    fi

    # Inisialisasi LXD minimal jika belum ada
    if ! lxc network list --format csv | grep -q "^lxdbr0,"; then
        show_msg "Menginisialisasi LXD..."
        cat <<EOF | sudo lxd init --preseed
config:
  core.https_address: '[::]:8443'
  core.trust_password: ""
storage_pools:
- name: default
  driver: dir
  config:
    source: /var/lib/lxd/storage-pools/default
networks:
- name: lxdbr0
  type: bridge
  config:
    ipv4.address: auto
    ipv6.address: none
profiles:
- name: default
  devices:
    root:
      path: /
      pool: default
      type: disk
    eth0:
      name: eth0
      network: lxdbr0
      type: nic
EOF
    fi
}

# 2. Buat container jika belum ada
function create_container() {
    if ! lxc info $CONTAINER_NAME &> /dev/null; then
        show_msg "Membuat container baru..."
        
        # Download image terlebih dahulu
        lxc image copy $CONTAINER_IMAGE local: --alias ubuntu-focal --auto-update
        
        # Buat container dengan konfigurasi
        lxc init ubuntu-focal $CONTAINER_NAME \
            --storage default \
            -c security.nesting=true \
            -c security.privileged=true \
            -c limits.memory=2GB \
            -c limits.cpu=2
        
        show_msg("Menjalankan container...")
        lxc start $CONTAINER_NAME
        
        # Tunggu hingga container ready
        show_msg "Menunggu container siap..."
        sleep 10
        lxc exec $CONTAINER_NAME -- cloud-init status --wait
        
        show_success "Container $CONTAINER_NAME berhasil dibuat dan dijalankan"
    elif ! lxc list --format csv | grep -q "^$CONTAINER_NAME,RUNNING"; then
        show_msg "Menjalankan container yang sudah ada..."
        lxc start $CONTAINER_NAME
        sleep 5
    fi
}

# 3. Setup menu command
function setup_menu() {
    # Buat script utama
    sudo tee /usr/local/bin/vpn-menu > /dev/null <<'EOL'
#!/bin/bash

CONTAINER_NAME="vpn-container"

function check_container() {
    if ! lxc info $CONTAINER_NAME &> /dev/null; then
        echo "Error: Container $CONTAINER_NAME tidak ditemukan!"
        echo "Untuk membuat container baru, jalankan:"
        echo "  sudo vpn-container-install"
        return 1
    fi
    
    if [ "$(lxc list -f csv | grep "^$CONTAINER_NAME," | cut -d, -f4)" != "RUNNING" ]; then
        echo "Starting container $CONTAINER_NAME..."
        if ! lxc start $CONTAINER_NAME; then
            echo "Error: Gagal menjalankan container"
            return 1
        fi
        sleep 3
    fi
    return 0
}

case "$1" in
    "--install"|"-i")
        exec /usr/local/bin/vpn-container-install
        ;;
    *)
        if check_container; then
            echo "Memasuki container $CONTAINER_NAME..."
            exec lxc exec $CONTAINER_NAME -- bash
        else
            exit 1
        fi
        ;;
esac
EOL

    # Buat script installer
    sudo tee /usr/local/bin/vpn-container-install > /dev/null <<'EOL'
#!/bin/bash
# Redirect ke installer asli
exec $(dirname "$0")/vpn-container-install.sh
EOL

    # Buat symlink ke script ini
    sudo ln -sf $(readlink -f "$0") /usr/local/bin/vpn-container-install.sh

    sudo chmod +x /usr/local/bin/vpn-menu
    sudo chmod +x /usr/local/bin/vpn-container-install
    sudo chmod +x /usr/local/bin/vpn-container-install.sh

    # Buat alias di bashrc
    if ! grep -q "alias menu=" ~/.bashrc; then
        echo "alias menu='vpn-menu'" >> ~/.bashrc
        source ~/.bashrc
    fi
}

# Main installation procedure
show_msg "Memulai instalasi VPN Container..."

# Jalankan semua fungsi setup
setup_lxd
create_container
setup_menu

# Verifikasi akhir
if lxc list --format csv | grep -q "^$CONTAINER_NAME,RUNNING"; then
    show_success "Instalasi berhasil!"
    echo -e "\nSekarang Anda bisa menggunakan:"
    echo -e "  \033[1;32mmenu\033[0m       - Masuk ke container"
    echo -e "  \033[1;32mlxc list\033[0m   - Lihat daftar container"
    echo -e "\nUntuk masuk ke container, cukup ketik 'menu'"
else
    show_error "Instalasi tidak sepenuhnya berhasil"
    echo "Anda bisa mencoba:"
    echo "1. Jalankan installer lagi:"
    echo "   sudo $(readlink -f "$0")"
    echo "2. Atau buat container manual:"
    echo "   lxc launch ubuntu:20.04 $CONTAINER_NAME"
    echo "   lxc config set $CONTAINER_NAME security.nesting true"
    exit 1
fi
