#!/bin/bash

# Cek apakah sudah root
if [ "$(id -u)" -ne 0 ]; then
  echo "❌ Harap jalankan script ini sebagai root (sudo)"
  exit 1
fi

echo "[*] Update & install LXD..."
apt update && apt install lxd -y

echo "[*] Init LXD default profile..."
lxd init --auto

echo "[*] Membuat container Ubuntu 20.04 bernama 'legacy-script-env'..."
lxc launch ubuntu:20.04 legacy-script-env

echo "[*] Menunggu container aktif..."
sleep 10

echo "[*] Menyiapkan dependensi di dalam container..."
lxc exec legacy-script-env -- bash -c "
  apt update && apt upgrade -y &&
  apt install -y python2 gcc make curl wget unzip zip screen gnupg net-tools iproute2 iptables nginx dropbear cron htop iftop rsyslog bzip2 gzip dos2unix nano vim mc git cmake libreadline-dev zlib1g-dev libssl-dev libsqlite3-dev libxml-parser-perl python3 python3-pip ruby jq bc
"

echo "[*] Menambahkan alias global 'menu'..."

# Cek dan tambahkan alias ke /etc/bash.bashrc
if ! grep -q "alias menu=" /etc/bash.bashrc; then
  echo "alias menu='lxc exec legacy-script-env -- bash'" >> /etc/bash.bashrc
  echo "✅ Alias global 'menu' ditambahkan ke /etc/bash.bashrc"
else
  echo "ℹ️ Alias 'menu' sudah ada di /etc/bash.bashrc"
fi

echo ""
echo "✅ Selesai! Container 'legacy-script-env' siap digunakan."
echo "➡️ Ketik perintah 'menu' dari terminal manapun untuk masuk ke dalam container."
echo "🧠 Alias akan aktif untuk semua user saat terminal baru dibuka."
