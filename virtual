#!/bin/bash

# ==============================================
# VPN CONTAINER DEFINITIVE SOLUTION
# ==============================================

CONTAINER_NAME="vpn-container"
CONTAINER_IMAGE="ubuntu:20.04"

# Fungsi untuk menampilkan pesan
function show_msg() {
    echo -e "\033[1;36m>>> $1\033[0m"
}

function show_error() {
    echo -e "\033[1;31m!!! $1\033[0m"
}

function show_success() {
    echo -e "\033[1;32mâœ“ $1\033[0m"
}

# 1. Full cleanup
function nuclear_cleanup() {
    show_msg "Melakukan pembersihan total..."
    
    # Stop and remove all containers
    sudo lxc list --format csv | cut -d, -f1 | xargs -I {} sudo lxc delete {} --force 2>/dev/null
    
    # Remove LXD completely
    sudo snap remove --purge lxd
    sudo apt remove --purge lxd lxd-client -y
    
    # Clean all directories
    sudo rm -rf /var/snap/lxd
    sudo rm -rf /var/lib/lxd
    sudo rm -rf /var/cache/lxd
    sudo rm -rf ~/.config/lxc
    sudo rm -rf /root/snap/lxd
    
    # Clean mounts
    sudo umount /var/snap/lxd/common/ns/* 2>/dev/null || true
}

# 2. System preparation
function prepare_system() {
    show_msg "Mempersiapkan sistem..."
    
    # Update system
    sudo apt update
    sudo apt upgrade -y
    
    # Install required packages
    sudo apt install -y snapd zfsutils-linux bridge-utils
    
    # Enable snapd
    sudo systemctl enable --now snapd.socket
    
    # Create necessary directories
    sudo mkdir -p /var/lib/lxd/storage-pools/default
    sudo chmod -R 777 /var/lib/lxd  # Temporary permission for debugging
}

# 3. Install LXD with minimal config
function install_lxd() {
    show_msg "Menginstal LXD..."
    
    # Install LXD
    sudo snap install lxd --channel=latest/stable
    
    # Wait for installation
    sleep 10
    
    # Add user to groups
    sudo usermod -aG lxd $USER
    newgrp lxd
    
    # Initialize LXD with minimal config
    show_msg "Menginisialisasi LXD..."
    cat <<EOF | sudo lxd init --preseed
config:
  core.https_address: '[::]:8443'
storage_pools:
- name: default
  driver: dir
  config:
    source: /var/lib/lxd/storage-pools/default
networks:
- name: lxdbr0
  type: bridge
profiles:
- name: default
  devices:
    eth0:
      name: eth0
      network: lxdbr0
      type: nic
EOF
}

# 4. Create container with explicit storage
function create_container() {
    show_msg "Membuat container dengan storage eksplisit..."
    
    # Create new profile with root disk
    sudo lxc profile create vpn-profile
    cat <<EOF | sudo lxc profile edit vpn-profile
config: {}
description: VPN Container Profile
devices:
  eth0:
    name: eth0
    network: lxdbr0
    type: nic
  root:
    path: /
    pool: default
    type: disk
EOF

    # Create container using the new profile
    sudo lxc launch $CONTAINER_IMAGE $CONTAINER_NAME -p vpn-profile
    
    # Configure container
    sudo lxc config set $CONTAINER_NAME security.nesting true
    sudo lxc config set $CONTAINER_NAME security.privileged true
    sudo lxc config set $CONTAINER_NAME limits.memory 2GB
    sudo lxc config set $CONTAINER_NAME limits.cpu 2
    
    # Wait for container
    show_msg "Menunggu container siap..."
    sleep 15
    sudo lxc exec $CONTAINER_NAME -- cloud-init status --wait
}

# 5. Create foolproof menu
function create_foolproof_menu() {
    show_msg "Membuat menu anti-gagal..."
    
    # Create menu script
    sudo tee /usr/local/bin/vpn-menu > /dev/null <<'EOL'
#!/bin/bash

CONTAINER_NAME="vpn-container"

# Fix environment issues
unset XDG_RUNTIME_DIR
export HOME=/root

# Ensure LXD is running
sudo systemctl start snap.lxd.daemon

# Check if container exists
if ! sudo lxc list --format csv | grep -q "^$CONTAINER_NAME,"; then
    echo "Membuat container baru..."
    sudo mkdir -p /var/lib/lxd/storage-pools/default
    sudo lxc profile create vpn-profile-temp 2>/dev/null || true
    cat <<PROFILE | sudo lxc profile edit vpn-profile-temp
config: {}
description: Temporary VPN Profile
devices:
  eth0:
    name: eth0
    network: lxdbr0
    type: nic
  root:
    path: /
    pool: default
    type: disk
PROFILE
    sudo lxc launch ubuntu:20.04 $CONTAINER_NAME -p vpn-profile-temp
    sudo lxc config set $CONTAINER_NAME security.nesting true
    sudo lxc config set $CONTAINER_NAME security.privileged true
    sudo lxc start $CONTAINER_NAME
    sleep 20
fi

# Start container if needed
if [ "$(sudo lxc list -f csv | grep "^$CONTAINER_NAME," | cut -d, -f4)" != "RUNNING" ]; then
    echo "Menjalankan container..."
    sudo lxc start $CONTAINER_NAME
    sleep 10
fi

echo "Memasuki container $CONTAINER_NAME..."
exec sudo lxc exec $CONTAINER_NAME -- bash
EOL

    sudo chmod +x /usr/local/bin/vpn-menu
    
    # Create alias
    echo "alias menu='sudo vpn-menu'" >> ~/.bashrc
    source ~/.bashrc
}

# Main process
show_msg "Memulai instalasi definitif..."

# Execute all steps
nuclear_cleanup
prepare_system
install_lxd
create_container
create_foolproof_menu

# Final verification
if sudo lxc list --format csv | grep -q "^$CONTAINER_NAME,RUNNING"; then
    show_success "INSTALASI BERHASIL!"
    echo -e "\nGunakan perintah berikut:"
    echo -e "  \033[1;32mmenu\033[0m     - Untuk masuk ke container"
    echo -e "  \033[1;32mlxc list\033[0m - Untuk melihat container"
else
    show_error "Instalasi mengalami masalah. Coba langkah manual berikut:"
    echo "1. sudo mkdir -p /var/lib/lxd/storage-pools/default"
    echo "2. sudo lxc profile create vpn-manual"
    echo "3. sudo lxc profile edit vpn-manual"
    echo "   Tambahkan device root disk dengan config:"
    echo "   root:"
    echo "     path: /"
    echo "     pool: default"
    echo "     type: disk"
    echo "4. sudo lxc launch ubuntu:20.04 vpn-container -p vpn-manual"
fi
