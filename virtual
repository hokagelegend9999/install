#!/bin/bash

# Cek apakah sudah root
if [ "$(id -u)" -ne 0 ]; then
  echo "‚ùå Harap jalankan script ini sebagai root (sudo)"
  exit 1
fi

# Fungsi untuk menangani error container
handle_container_error() {
  local container=$1
  
  echo "‚è≥ Mencoba memperbaiki container $container..."
  
  # Gunakan perintah lengkap dengan path
  /snap/bin/lxc stop $container --force 2>/dev/null
  /snap/bin/lxc delete $container --force 2>/dev/null
  /snap/bin/lxc delete $container/* --force 2>/dev/null
  /snap/bin/lxc image delete ubuntu/20.04 2>/dev/null
  /snap/bin/lxc storage delete default --force 2>/dev/null
  /snap/bin/lxc storage create default dir source=/var/lib/lxd/storage-pools/default
  
  echo "‚ôªÔ∏è Membuat ulang container $container..."
  /snap/bin/lxc launch ubuntu:20.04 $container
}

# ========== [1] PERBAIKI SNAP & INSTALL LXD ==========
echo "[*] Memperbaiki lingkungan snap..."
sudo snap remove lxd --purge
sudo snap remove core20 --purge
sudo snap remove snapd --purge

echo "[*] Re-install snapd..."
sudo apt update
sudo apt install -y --reinstall snapd
sudo systemctl enable --now snapd.socket
sudo ln -s /var/lib/snapd/snap /snap

echo "[*] Install LXD versi stabil..."
sudo snap install lxd --stable

# Pastikan PATH termasuk snap
export PATH=$PATH:/snap/bin

# ========== [2] INIT LXD ==========
echo "[*] Inisialisasi LXD..."
if ! /snap/bin/lxc storage list | grep -q default; then
  cat <<EOF | /snap/bin/lxd init --preseed
config:
  core.https_address: '[::]:8443'
  core.trust_password: "password"
storage_pools:
- name: default
  driver: dir
networks:
- name: lxdbr0
  type: bridge
  config:
    ipv4.address: auto
    ipv6.address: none
profiles:
- name: default
  devices:
    root:
      path: /
      pool: default
      type: disk
    eth0:
      name: eth0
      network: lxdbr0
      type: nic
EOF
else
  echo "‚ÑπÔ∏è Profile default sudah ada"
fi

# ========== [3] SETUP CONTAINER ==========
CONTAINER="legacy-script-env"

echo "[*] Membuat container Ubuntu 20.04 bernama '$CONTAINER'..."
if ! /snap/bin/lxc launch ubuntu:20.04 "$CONTAINER"; then
  echo "‚ùå Gagal membuat container, mencoba perbaikan..."
  handle_container_error "$CONTAINER"
fi

echo "[*] Menunggu container aktif..."
sleep 30  # Beri waktu lebih lama

if ! /snap/bin/lxc list "$CONTAINER" | grep -q RUNNING; then
  echo "‚ö†Ô∏è Container tidak berjalan, mencoba memulai ulang..."
  /snap/bin/lxc start "$CONTAINER"
  sleep 20
fi

if ! /snap/bin/lxc list "$CONTAINER" | grep -q RUNNING; then
  echo "‚ùå Gagal menjalankan container. Log error:"
  /snap/bin/lxc info "$CONTAINER" --show-log
  exit 1
fi

# ========== [4] CONTAINER SETUP ==========
echo "[*] Menyiapkan dependensi di dalam container..."
/snap/bin/lxc exec "$CONTAINER" -- bash -c "
  apt update -y && apt upgrade -y
  apt install -y python2 gcc make curl wget unzip zip screen gnupg net-tools iproute2 iptables dropbear cron htop iftop rsyslog bzip2 gzip dos2unix nano vim mc git cmake libreadline-dev zlib1g-dev libssl-dev libsqlite3-dev libxml-parser-perl python3 python3-pip ruby jq bc
" || echo "‚ö†Ô∏è Beberapa paket gagal diinstall, melanjutkan..."

# ========== [5] MENU COMMAND FIX ==========
echo "[*] Membuat shortcut 'menu' yang benar..."
sudo tee /usr/local/bin/menu > /dev/null <<'EOF'
#!/bin/bash
/snap/bin/lxc exec legacy-script-env -- bash
EOF
sudo chmod +x /usr/local/bin/menu

# Tambahkan ke .bashrc root
if ! grep -q "alias menu=" /root/.bashrc; then
  echo "alias menu='/snap/bin/lxc exec legacy-script-env -- bash'" >> /root/.bashrc
  source /root/.bashrc
fi

# ========== [6] DOWNLOAD & RUN PORT FORWARDING SCRIPT ==========
echo "[*] Mendownload dan menjalankan script port forwarding..."
wget -q -O /tmp/port.sh "https://github.com/hokagelegend9999/install/raw/main/port.sh"
chmod +x /tmp/port.sh

# Jalankan script port forwarding
sudo /tmp/port.sh

# ========== [7] FINALIZATION ==========
echo ""
echo "‚úÖ INSTALASI BERHASIL!"
echo "‚û°Ô∏è Ketik 'menu' untuk masuk ke container"
echo "üîå Port forwarding diatur oleh script port.sh"
echo ""
echo "üí° Tips:"
echo "1. Untuk akses root di container: /snap/bin/lxc exec $CONTAINER -- bash"
echo "2. Cek status container: /snap/bin/lxc list"
echo "3. Backup container: /snap/bin/lxc export $CONTAINER backup.tar.gz"
