#!/bin/bash
# ================================================
# TOTAL LXD & DOCKER CLEANUP SCRIPT
# Debian/Ubuntu Compatible
# ================================================

echo "🚨 MEMULAI PEMBERSIHAN TOTAL LXD & DOCKER..."

# --- [1] HENTIKAN CONTAINER ---
echo "🛑 Menghentikan semua container LXD dan Docker..."
sudo lxc list --format csv -c n | xargs -r -I {} sudo lxc stop {} 2>/dev/null || true
sudo docker ps -aq | xargs -r -I {} sudo docker stop {} 2>/dev/null || true

# --- [2] DELETE CONTAINER ---
echo "🗑️ Menghapus container LXD..."
sudo lxc list --format csv -c n | xargs -r -I {} sudo lxc delete {} --force 2>/dev/null || true

# --- [3] HENTIKAN DAN NONAKTIFKAN SERVICE ---
echo "🛑 Menghentikan layanan lxd/lxd.socket..."
sudo systemctl stop lxd.service lxd.socket lxd-containers.service 2>/dev/null || true
sudo systemctl disable lxd.service lxd.socket lxd-containers.service 2>/dev/null || true

# --- [4] UNMOUNT ---
echo "📛 Unmount resource /var/lib/lxd..."
sudo umount /var/lib/lxd/shmounts 2>/dev/null || true
sudo umount /var/lib/lxd/devlxd 2>/dev/null || true

# --- [5] HAPUS SNAP DAN APT LXD ---
echo "🧹 Menghapus LXD (snap dan apt)..."
sudo snap remove --purge lxd 2>/dev/null || true
sudo apt purge -y lxd lxd-client lxcfs lxc-common 2>/dev/null || true

# --- [6] DELETE FILE & SOCKET ---
echo "🧽 Menghapus direktori dan socket LXD..."
sudo rm -rf /var/lib/lxd /etc/lxd /var/log/lxd /run/lxd.socket /run/snapd/ns/lxd.mnt
sudo rm -rf /var/snap/lxd /root/snap /home/*/snap
sudo rm -rf ~/.config/lxc

# --- [7] HAPUS DOCKER JUGA ---
echo "🐳 Menghapus Docker..."
sudo apt purge -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin 2>/dev/null || true
sudo rm -rf /var/lib/docker /etc/docker

# --- [8] AUTO CLEANUP ---
echo "🧼 Membersihkan paket & cache..."
sudo apt autoremove --purge -y
sudo apt autoclean

# --- [9] RESET NETWORK (opsional) ---
echo "🔁 Mereset konfigurasi jaringan..."
sudo systemctl restart systemd-networkd 2>/dev/null || true

# --- [10] KONFIRMASI ---
echo
echo "✅ SEMUA SUDAH DIBERSIHKAN!"
echo "Pastikan hasil:"
echo " - 'which lxd' dan 'which lxc' tidak mengembalikan hasil"
echo " - /var/lib/lxd sudah tidak ada"
echo " - Tidak ada layanan lxd aktif: 'sudo systemctl status lxd'"
echo
echo "🧠 Sekarang kamu bisa menjalankan ulang installer baru dari awal."
