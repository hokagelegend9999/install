#!/bin/bash

if [ "$(id -u)" -ne 0 ]; then
  echo "❌ Jalankan sebagai root (sudo)"
  exit 1
fi

if ! command -v lxc >/dev/null 2>&1; then
  echo "ℹ️ LXC belum terinstall, melewati penghapusan container"
else
  echo "🔥 Menghapus semua container LXD..."

  # Ambil daftar container valid (hindari baris kosong dan pesan status)
  containers=$(lxc list --format csv -c n | grep -v -E '^$|Installing|pending|Stopping|Starting')

  for container in $containers; do
    echo "⏳ Menghentikan container: $container"
    lxc stop "$container" --force || echo "⚠️ Gagal menghentikan $container, lanjut..."
    echo "🗑️ Menghapus container: $container"
    lxc delete "$container" || echo "⚠️ Gagal menghapus $container, lanjut..."
  done
fi

echo "🛑 Menghentikan layanan LXD jika ada..."
systemctl stop snap.lxd.daemon 2>/dev/null || echo "ℹ️ Layanan snap.lxd.daemon tidak berjalan"

echo "📦 Menghapus snap LXD jika terinstall..."
snap remove lxd --purge 2>/dev/null || echo "ℹ️ Snap LXD tidak terpasang"

echo "🧹 Membersihkan direktori data LXD..."
rm -rf /var/snap/lxd ~/snap/lxd

echo "✅ LXD dan semua data sudah dibersihkan."
