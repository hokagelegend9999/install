#!/bin/bash
# ================================================
# CLEANUP PREVIOUS INSTALLATION (LXD/DOCKER)
# DEBIAN 12 COMPATIBLE
# ================================================

# --- [1] HENTIKAN SEMUA CONTAINER ---
echo "🛑 Menghentikan container yang aktif..."
sudo lxc list --format csv -c n | xargs -I {} sudo lxc stop {} 2>/dev/null || true
sudo docker ps -aq | xargs -I {} sudo docker stop {} 2>/dev/null || true

# --- [2] HAPUS CONTAINER ---
echo "🗑️ Menghapus container LXD..."
sudo lxc list --format csv -c n | xargs -I {} sudo lxc delete {} --force 2>/dev/null || true

# --- [3] HAPUS DOCKER ---
echo "🧹 Membersihkan instalasi Docker..."
sudo apt remove -y --purge docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin 2>/dev/null || true
sudo rm -rf /var/lib/docker /etc/docker

# --- [4] HAPUS LXD ---
echo "🧹 Membersihkan instalasi LXD..."
sudo snap remove --purge lxd 2>/dev/null || true
sudo rm -rf /var/snap/lxd /var/lib/lxd

# --- [5] HAPUS PROFIL & NETWORK ---
echo "🧽 Membersihkan profil LXD..."
sudo rm -rf /var/lib/lxd/storage-pools/default/containers/* 2>/dev/null || true
sudo lxc profile delete tunnel 2>/dev/null || true
sudo lxc network delete lxdbr0 2>/dev/null || true

# --- [6] HAPUS SHORTCUT ---
echo "🔧 Menghapus shortcut menu..."
sudo rm -f /usr/local/bin/menu 2>/dev/null || true

# --- [7] HAPUS DEPENDENSI TIDAK TERPAKAI ---
echo "🧹 Membersihkan paket tidak terpakai..."
sudo apt autoremove -y
sudo apt autoclean

# --- [8] RESET KONFIGURASI ---
echo "🔄 Mereset konfigurasi jaringan..."
sudo systemctl restart systemd-networkd

# --- [9] SELESAI ---
cat <<EOF

✅ PEMBERSIHAN SELESAI!

Sistem sekarang bersih dari:
- Semua container LXD
- Instalasi Docker
- Konfigurasi jaringan LXD
- File residual

Langkah berikutnya:
1. Jalankan installer baru
2. Setup ulang container

🔥 Tips: Backup konfigurasi penting sebelum membersihkan!
EOF
