#!/bin/bash

echo "🧹 Memulai proses penghapusan total LXD..."

# --- 1. Stop dan hapus semua container LXD ---
echo "🛑 Menghentikan dan menghapus container LXD (jika ada)..."
if command -v lxc >/dev/null 2>&1; then
    sudo lxc list --format csv -c n | xargs -r -I {} sudo lxc stop {} --force 2>/dev/null || true
    sudo lxc list --format csv -c n | xargs -r -I {} sudo lxc delete {} --force 2>/dev/null || true
fi

# --- 2. Stop service LXD Snap ---
if systemctl list-units --type=service | grep -q snap.lxd.daemon; then
    echo "⏹️ Menghentikan service LXD snap..."
    sudo systemctl stop snap.lxd.daemon
fi

# --- 3. Unmount mount points di /var/lib/lxd ---
echo "📂 Memeriksa dan melepaskan mount di /var/lib/lxd..."
mountpoints=$(mount | grep '/var/lib/lxd' | awk '{print $3}' | sort -r)
for mnt in $mountpoints; do
    echo "📤 Unmount $mnt"
    sudo umount -lf "$mnt" || true
done

# --- 4. Remove Snap LXD ---
if snap list | grep -q '^lxd'; then
    echo "❌ Menghapus LXD Snap..."
    sudo snap remove --purge lxd || true
fi

# --- 5. Remove APT LXD & dependencies ---
echo "❌ Menghapus paket LXD APT dan terkait..."
sudo apt purge -y lxd lxd-client lxcfs lxc-common lxc1 || true
sudo apt autoremove -y
sudo apt autoclean -y

# --- 6. Hapus folder konfigurasi dan data ---
echo "🗑️ Menghapus folder konfigurasi dan data LXD..."
sudo rm -rf /var/lib/lxd /var/snap/lxd /etc/lxd /var/log/lxd || true

# --- 7. Restart systemd dan network (optional) ---
echo "🔄 Merestart systemd dan konfigurasi network..."
sudo systemctl daemon-reload
sudo systemctl restart systemd-networkd || true

echo ""
echo "✅ Proses pembersihan LXD selesai."
echo "Silakan reboot sistem untuk memastikan semua bersih."
