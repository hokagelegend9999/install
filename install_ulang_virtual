#!/bin/bash

if [ "$(id -u)" -ne 0 ]; then
  echo "âŒ Jalankan sebagai root (sudo)"
  exit 1
fi

if ! command -v lxc >/dev/null 2>&1; then
  echo "â„¹ï¸ LXC belum terinstall, melewati penghapusan container"
else
  echo "ğŸ”¥ Menghapus semua container LXD..."

  # Ambil daftar container valid (hindari baris kosong dan pesan status)
  containers=$(lxc list --format csv -c n | grep -v -E '^$|Installing|pending|Stopping|Starting')

  for container in $containers; do
    echo "â³ Menghentikan container: $container"
    lxc stop "$container" --force || echo "âš ï¸ Gagal menghentikan $container, lanjut..."
    echo "ğŸ—‘ï¸ Menghapus container: $container"
    lxc delete "$container" || echo "âš ï¸ Gagal menghapus $container, lanjut..."
  done
fi

echo "ğŸ›‘ Menghentikan layanan LXD jika ada..."
systemctl stop snap.lxd.daemon 2>/dev/null || echo "â„¹ï¸ Layanan snap.lxd.daemon tidak berjalan"

echo "ğŸ“¦ Menghapus snap LXD jika terinstall..."
snap remove lxd --purge 2>/dev/null || echo "â„¹ï¸ Snap LXD tidak terpasang"

echo "ğŸ§¹ Membersihkan direktori data LXD..."
rm -rf /var/snap/lxd ~/snap/lxd

echo "âœ… LXD dan semua data sudah dibersihkan."
