#!/bin/bash
# ==========================================
#   ZIVPN AUTO INSTALLER PREMIUM (FIXED)
#   Mode: Username Only (No Password in Config)
#   Integrated: Bot Helper & Clean Menu
# ==========================================

# Warna
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

clear
echo -e "${BLUE}=================================================${NC}"
echo -e "${YELLOW}       INSTALLER ZIVPN PREMIUM (FIXED)           ${NC}"
echo -e "${BLUE}=================================================${NC}"
echo ""

# 1. Update & Install Dependencies
echo -e "${GREEN}[1/9] Update Repository & Install Tools...${NC}"
apt-get update -y > /dev/null 2>&1
apt-get install -y wget curl jq openssl net-tools bc iptables-persistent > /dev/null 2>&1

# 2. Stop Service Lama & Bersihkan File
systemctl stop zivpn > /dev/null 2>&1
rm -f /usr/local/bin/zivpn
rm -f /usr/bin/zivpn
rm -f /usr/local/bin/zivpn-add
rm -f /usr/local/bin/zivpn-menu

# 3. Download Binary ZIVPN
echo -e "${GREEN}[2/9] Download Core ZIVPN...${NC}"
wget -q https://github.com/zahidbd2/udp-zivpn/releases/download/udp-zivpn_1.4.9/udp-zivpn-linux-amd64 -O /usr/local/bin/zivpn-core
chmod +x /usr/local/bin/zivpn-core

# 4. Setup Config & Database
echo -e "${GREEN}[3/9] Mengkonfigurasi Database...${NC}"
mkdir -p /etc/zivpn

# Generate Certificate
rm -f /etc/zivpn/zivpn.crt /etc/zivpn/zivpn.key
openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=ID/ST=Jakarta/L=Jakarta/O=ZIVPN/OU=Premium/CN=zivpn" -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" > /dev/null 2>&1

# Buat Config Utama (Mode: Passwords tapi isi array String biasa)
cat <<EOF > /etc/zivpn/config.json
{
  "listen": ":5667",
  "cert": "/etc/zivpn/zivpn.crt",
  "key": "/etc/zivpn/zivpn.key",
  "obfs": "zivpn",
  "auth": {
    "mode": "passwords",
    "config": []
  }
}
EOF

# User DB
if [ ! -f /etc/zivpn/user-db.json ]; then
    echo "{}" > /etc/zivpn/user-db.json
fi

# 5. Membuat Script Helper untuk Bot (zivpn-add)
# Script ini sangat penting agar Bot Python Anda bisa create user
echo -e "${GREEN}[4/9] Membuat Helper Script (Bridge Python)...${NC}"
cat << 'EOF' > /usr/local/bin/zivpn-add
#!/bin/bash
# ==========================================
#  ZIVPN HELPER (MODE: USERNAME ONLY)
#  Auto-Clean Invisible Characters
# ==========================================

# Bersihkan Input
USERNAME=$(echo "$1" | tr -d '\r\n[:space:]')
PASSWORD=$(echo "$2" | tr -d '\r\n[:space:]')
EXP_DAYS=$(echo "$3" | tr -d '\r\n[:space:]')
IP_LIMIT=$(echo "$4" | tr -d '\r\n[:space:]')
QUOTA=$(echo "$5" | tr -d '\r\n[:space:]')

# Default Value
[ -z "$IP_LIMIT" ] && IP_LIMIT="2"
[ -z "$QUOTA" ] && QUOTA="0"
[ -z "$EXP_DAYS" ] && EXP_DAYS="30"

CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"

# Cek Duplikat
if jq -e ".auth.config | index(\"$USERNAME\")" "$CONFIG_FILE" > /dev/null; then
    exit 0
fi

# Hitung Expired
EXP_DATE=$(date -d "+$EXP_DAYS days" +%Y-%m-%d)

# Simpan ke Config (HANYA USERNAME)
AUTH_STRING="${USERNAME}"

# Backup & Tulis Config
cp "$CONFIG_FILE" "${CONFIG_FILE}.tmp"
jq --arg auth "$AUTH_STRING" '.auth.config += [$auth]' "${CONFIG_FILE}.tmp" > "$CONFIG_FILE"
rm -f "${CONFIG_FILE}.tmp"

# Update Database (Metadata)
cp "$USER_DB" "${USER_DB}.tmp"
jq --arg u "$USERNAME" --arg e "$EXP_DATE" --arg i "$IP_LIMIT" --arg q "$QUOTA" \
   '.[$u] = {exp: $e, ip: $i, quota: $q}' "${USER_DB}.tmp" > "$USER_DB"
rm -f "${USER_DB}.tmp"

# Restart Service
systemctl restart zivpn
EOF
chmod +x /usr/local/bin/zivpn-add

# 6. Auto-Sync User SSH Lama (Backup)
echo -e "${GREEN}[5/9] Sinkronisasi User SSH Lama...${NC}"
SSH_DB="/etc/ssh/.ssh.db"
CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"

if [ -f "$SSH_DB" ]; then
    grep "^#ssh#" "$SSH_DB" | while read -r line; do
        user=$(echo $line | awk '{print $2}')
        quota=$(echo $line | awk '{print $4}')
        ip=$(echo $line | awk '{print $5}')
        exp_raw=$(echo $line | cut -d ' ' -f 6-)
        exp_date=$(date -d "$exp_raw" +%Y-%m-%d 2>/dev/null)
        if [[ -z "$exp_date" ]]; then exp_date=$(date +%Y-%m-%d); fi

        if [[ -n "$user" ]]; then
            # Sync Logic: Username Only
            if ! jq -e ".auth.config | index(\"$user\")" "$CONFIG_FILE" > /dev/null; then
                cp "$CONFIG_FILE" "${CONFIG_FILE}.tmp"
                jq --arg u "$user" '.auth.config += [$u]' "${CONFIG_FILE}.tmp" > "$CONFIG_FILE"
                
                [ -z "$quota" ] && quota=0
                [ -z "$ip" ] && ip=2
                cp "$USER_DB" "${USER_DB}.tmp"
                jq --arg u "$user" --arg e "$exp_date" --arg i "$ip" --arg q "$quota" \
                   '.[$u] = {exp: $e, ip: $i, quota: $q}' "${USER_DB}.tmp" > "$USER_DB"
            fi
        fi
    done
    rm -f /etc/zivpn/*.tmp
fi

# 7. Install Menu Manager (Updated Logic)
echo -e "${GREEN}[6/9] Menginstall Menu Manager (Fixed)...${NC}"
cat << 'EOF' > /usr/local/bin/zivpn-menu
#!/bin/bash
# ==========================================
#  ZIVPN MENU (MODE: USERNAME ONLY)
# ==========================================

CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"
SERVICE_NAME="zivpn.service"

# Warna
RED='\e[1;31m'
GREEN='\e[1;32m'
YELLOW='\e[1;33m'
BLUE='\e[1;34m'
PURPLE='\e[1;35m'
CYAN='\e[1;36m'
NC='\e[0m'
WH='\e[1;37m'
BOLD='\e[1m'

function restart_service() { 
    systemctl restart "$SERVICE_NAME"
}

function header() {
    clear
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${WH}            ⚡ ZIVPN PREMIUM MANAGER ⚡            ${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
}

function show_main_menu() {
    header
    # System Info
    if [ -f /etc/os-release ]; then 
        OS_NAME=$(grep -w PRETTY_NAME /etc/os-release | cut -d= -f2 | tr -d '"')
    else 
        OS_NAME="Linux"
    fi
    
    if systemctl is-active --quiet "$SERVICE_NAME"; then 
        STATUS_SRV="${GREEN}RUNNING [ON]${NC}"
    else 
        STATUS_SRV="${RED}STOPPED [OFF]${NC}"
    fi

    echo -e " ${PURPLE}» OS System   :${WH} $OS_NAME"
    echo -e " ${PURPLE}» Status VPN  :${WH} $STATUS_SRV"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e " ${BOLD}MENU UTAMA:${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "  ${GREEN}[1]${NC} • Buat User Baru"
    echo -e "  ${GREEN}[2]${NC} • List User & Monitor"
    echo -e "  ${GREEN}[3]${NC} • Perpanjang User"
    echo -e "  ${GREEN}[4]${NC} • Hapus User"
    echo -e "  ${GREEN}[5]${NC} • Cek Service Log"
    echo -e "  ${GREEN}[6]${NC} • Auto Hapus Expired"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "  ${RED}[0]${NC} • Exit / Keluar"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -ne " ${YELLOW}⇨  Pilih Menu [0-6]: ${NC}"
}

function add_user() {
    header
    echo -e " ${CYAN}CREATE NEW USER${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    read -p " » Username : " username
    if [[ -z "$username" ]]; then echo -e "\n${RED}❌ Input tidak boleh kosong!${NC}"; sleep 1; return; fi
    
    if jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then 
        echo -e "\n${RED}❌ Username '$username' sudah ada!${NC}"; sleep 2; return; 
    fi
    
    read -p " » Password : " password 
    read -p " » Expired (hari) : " masa_aktif
    [ -z "$masa_aktif" ] && masa_aktif=30
    exp_date=$(date -d "+$masa_aktif days" +%Y-%m-%d)
    
    # SIMPAN HANYA USERNAME
    cp "$CONFIG_FILE" "${CONFIG_FILE}.bak"
    jq --arg auth "$username" '.auth.config += [$auth]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
    
    jq --arg u "$username" --arg e "$exp_date" --arg i "2" --arg q "0" \
       '.[$u] = {exp: $e, ip: $i, quota: $q}' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
    
    restart_service
    echo -e " ✅ ${GREEN}User Berhasil Dibuat!${NC}"
    read -n 1 -s -r -p "Tekan Enter untuk kembali..."
}

function list_users() {
    header
    echo -e " ${CYAN}LIST USER ZIVPN${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    printf "${YELLOW}%-4s %-15s %-12s %-10s %s${NC}\n" "No" "Username" "Expired" "Status" "Quota"
    echo -e "${BLUE}--------------------------------------------------${NC}"
    
    count_user=$(jq '.auth.config | length' "$CONFIG_FILE")
    if [[ "$count_user" == "0" || "$count_user" == "null" ]]; then
          echo -e " ${RED}Data user kosong.${NC}"
    else
        no=1
        jq -r '.auth.config[]' "$CONFIG_FILE" | while read -r username; do
            if [[ -z "$username" || "$username" == "null" ]]; then continue; fi
            
            exp=$(jq -r --arg u "$username" '.[$u].exp // "Unknown"' "$USER_DB")
            quota=$(jq -r --arg u "$username" '.[$u].quota // "Unl"' "$USER_DB")
            
            status_show="${GREEN}ACTIVE${NC}"
            if [[ "$exp" != "Unknown" ]]; then
                today=$(date +%Y-%m-%d)
                if [[ "$today" > "$exp" ]]; then status_show="${RED}EXPIRED${NC}"; fi
            fi
            if [[ "$quota" == "0" || "$quota" == "Unl" ]]; then quota_show="Unl"; else quota_show="${quota}GB"; fi

            printf "%-4s %-15s %-12s %b %s\n" "$no" "$username" "$exp" "$status_show" "$quota_show"
            ((no++))
        done
    fi
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    read -n 1 -s -r -p "Tekan Enter untuk kembali..."
}

function del_user() {
    header
    echo -e " ${CYAN}DELETE USER${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    read -p " » Username : " username
    
    if jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then
        jq --arg u "$username" '.auth.config -= [$u]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
        jq --arg u "$username" 'del(.[$u])' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
        restart_service
        echo -e "\n ✅ ${GREEN}User $username telah dihapus.${NC}"
    else 
        echo -e "\n ${RED}❌ User tidak ditemukan.${NC}"
    fi
    read -n 1 -s -r -p "Tekan Enter untuk kembali..."
}

function delete_expired() {
    header
    echo -e " ${CYAN}AUTO DELETE EXPIRED${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    today=$(date +%Y-%m-%d)
    users=$(jq -r 'keys[]' "$USER_DB")
    count=0
    for user in $users; do
        exp=$(jq -r --arg u "$user" '.[$u].exp' "$USER_DB")
        if [[ "$today" > "$exp" ]]; then
            echo -e " - Menghapus: ${RED}$user${NC}"
            jq --arg u "$user" '.auth.config -= [$u]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
            jq --arg u "$user" 'del(.[$u])' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
            ((count++))
        fi
    done
    if [ $count -gt 0 ]; then restart_service; fi
    read -n 1 -s -r -p "Tekan Enter untuk kembali..."
}

while true; do
    show_main_menu
    read -r choice
    case $choice in
        1) add_user ;;
        2) list_users ;;
        3) renew_user ;;
        4) del_user ;;
        5) clear; journalctl -u "$SERVICE_NAME" -f -n 20 ;;
        6) delete_expired ;;
        0) clear; exit 0 ;;
        *) echo -e "\n ${RED}Pilihan salah!${NC}"; sleep 1 ;;
    esac
done
EOF

# 8. Setup Shortcut Command
echo -e "${GREEN}[7/9] Membuat Shortcut Command...${NC}"
chmod +x /usr/local/bin/zivpn-menu
ln -sf /usr/local/bin/zivpn-menu /usr/bin/zivpn
chmod +x /usr/bin/zivpn
hash -r

# 9. Setup Systemd Service
echo -e "${GREEN}[8/9] Membuat Service Systemd...${NC}"
cat <<EOF > /etc/systemd/system/zivpn.service
[Unit]
Description=ZIVPN UDP Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn
ExecStart=/usr/local/bin/zivpn-core server -c /etc/zivpn/config.json
Restart=always
RestartSec=3
Environment=ZIVPN_LOG_LEVEL=info
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

# 10. Firewall & Start
echo -e "${GREEN}[9/9] Setup Firewall & Start...${NC}"
sysctl -w net.ipv4.ip_forward=1 > /dev/null 2>&1
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

NIC=$(ip -4 route ls|grep default|grep -Po '(?<=dev )(\S+)'|head -1)
iptables -t nat -F
iptables -t nat -A PREROUTING -i $NIC -p udp --dport 6000:19999 -j DNAT --to-destination :5667
iptables -A INPUT -p udp --dport 5667 -j ACCEPT
netfilter-persistent save > /dev/null 2>&1

systemctl daemon-reload
systemctl enable zivpn
systemctl restart zivpn

clear
echo -e "${BLUE}=================================================${NC}"
echo -e "${GREEN}       INSTALASI SELESAI & COMMAND SIAP          ${NC}"
echo -e "${BLUE}=================================================${NC}"
echo -e " - Mode Config        : ${YELLOW}USERNAME ONLY${NC}"
echo -e " - Integrasi Bot      : ${YELLOW}SUKSES (zivpn-add dibuat)${NC}"
echo -e " - Menu ZiVPN         : Ketik ${YELLOW}zivpn${NC}"
echo -e "${BLUE}=================================================${NC}"
