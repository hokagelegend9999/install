#!/bin/bash
# ==========================================
#   ZIVPN AUTO INSTALLER PREMIUM (V4 PRO)
#   Fixed: UI Menu, Binary Path & Color Leaks
# ==========================================

# Warna (Installer)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

clear
echo -e "${BLUE}=================================================${NC}"
echo -e "${YELLOW}       INSTALLER ZIVPN PREMIUM (V4 PRO)          ${NC}"
echo -e "${BLUE}=================================================${NC}"
echo ""

# 1. Update & Install Dependencies
echo -e "${GREEN}[1/8] Update Repository & Install Tools...${NC}"
apt-get update -y > /dev/null 2>&1
apt-get install -y wget curl jq openssl net-tools bc iptables-persistent > /dev/null 2>&1

# 2. Stop Service Lama & Bersihkan File Konflik
systemctl stop zivpn > /dev/null 2>&1
rm -f /usr/local/bin/zivpn        # Hapus binary lama yang namanya bentrok
rm -f /usr/bin/zivpn              # Hapus shortcut lama

# 3. Download Binary ZIVPN (Disimpan sbg zivpn-core)
echo -e "${GREEN}[2/8] Download Core ZIVPN...${NC}"
wget -q https://github.com/zahidbd2/udp-zivpn/releases/download/udp-zivpn_1.4.9/udp-zivpn-linux-amd64 -O /usr/local/bin/zivpn-core
chmod +x /usr/local/bin/zivpn-core

# 4. Setup Config & Database
echo -e "${GREEN}[3/8] Mengkonfigurasi Database...${NC}"
mkdir -p /etc/zivpn

# Backup config lama
if [ -f /etc/zivpn/config.json ]; then
    cp /etc/zivpn/config.json /etc/zivpn/config.json.backup
fi

# Generate Certificate
rm -f /etc/zivpn/zivpn.crt /etc/zivpn/zivpn.key
openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=ID/ST=Jakarta/L=Jakarta/O=ZIVPN/OU=Premium/CN=zivpn" -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" > /dev/null 2>&1

# Buat Config Utama
cat <<EOF > /etc/zivpn/config.json
{
  "listen": ":5667",
  "cert": "/etc/zivpn/zivpn.crt",
  "key": "/etc/zivpn/zivpn.key",
  "obfs": "zivpn",
  "auth": {
    "mode": "passwords",
    "config": []
  }
}
EOF

# User DB
if [ ! -f /etc/zivpn/user-db.json ]; then
    echo "{}" > /etc/zivpn/user-db.json
fi

# 5. Auto-Sync User SSH
echo -e "${GREEN}[4/8] Sinkronisasi User SSH ke ZIVPN...${NC}"
SSH_DB="/etc/ssh/.ssh.db"
CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"

if [ -f "$SSH_DB" ]; then
    grep "^#ssh#" "$SSH_DB" | while read -r line; do
        user=$(echo $line | awk '{print $2}')
        quota=$(echo $line | awk '{print $4}')
        ip=$(echo $line | awk '{print $5}')
        exp_raw=$(echo $line | cut -d ' ' -f 6-)
        exp_date=$(date -d "$exp_raw" +%Y-%m-%d 2>/dev/null)
        if [[ -z "$exp_date" ]]; then exp_date=$(date +%Y-%m-%d); fi

        if [[ -n "$user" ]]; then
            cp "$CONFIG_FILE" "${CONFIG_FILE}.tmp"
            jq --arg u "$user" '.auth.config += [$u]' "${CONFIG_FILE}.tmp" > "$CONFIG_FILE"
            
            [ -z "$quota" ] && quota=0
            [ -z "$ip" ] && ip=2
            cp "$USER_DB" "${USER_DB}.tmp"
            jq --arg u "$user" --arg e "$exp_date" --arg i "$ip" --arg q "$quota" \
               '.[$u] = {exp: $e, ip: $i, quota: $q}' "${USER_DB}.tmp" > "$USER_DB"
        fi
    done
fi

# Default User (Jika perlu)
# cp "$CONFIG_FILE" "${CONFIG_FILE}.tmp"
# jq '.auth.config += ["zivpn"]' "${CONFIG_FILE}.tmp" > "$CONFIG_FILE"
rm -f /etc/zivpn/*.tmp

# 6. Install Menu PRO (Updated UI)
echo -e "${GREEN}[5/8] Menginstall Menu Manager V4 PRO...${NC}"
cat << 'EOF' > /usr/local/bin/zivpn-menu
#!/bin/bash
# ==========================================
#  ZIVPN MENU MANAGER V4 (PRO EDITION)
#  Fixed: Color Display & UI Layout
# ==========================================

# Konfigurasi File
CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"
SERVICE_NAME="zivpn.service"

# Palet Warna (ANSI Fixed)
RED='\e[1;31m'
GREEN='\e[1;32m'
YELLOW='\e[1;33m'
BLUE='\e[1;34m'
PURPLE='\e[1;35m'
CYAN='\e[1;36m'
NC='\e[0m'       # No Color
WH='\e[1;37m'    # Bold White
BOLD='\e[1m'

# Helper Functions
function restart_service() { 
    systemctl restart "$SERVICE_NAME"
}

function header() {
    clear
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${WH}           âš¡ ZIVPN PREMIUM MANAGER âš¡           ${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

function show_main_menu() {
    header
    # System Info
    if [ -f /etc/os-release ]; then 
        OS_NAME=$(grep -w PRETTY_NAME /etc/os-release | cut -d= -f2 | tr -d '"')
    else 
        OS_NAME="Linux"
    fi
    
    IP_VPS=$(curl -s --connect-timeout 2 ipv4.icanhazip.com)
    RAM_USED=$(free -m | awk '/Mem:/ {print $3}')
    RAM_TOTAL=$(free -m | awk '/Mem:/ {print $2}')
    
    # Cek Status Service
    if systemctl is-active --quiet "$SERVICE_NAME"; then 
        STATUS_SRV="${GREEN}RUNNING [ON]${NC}"
    else 
        STATUS_SRV="${RED}STOPPED [OFF]${NC}"
    fi

    echo -e " ${PURPLE}Â» OS System   :${WH} $OS_NAME"
    echo -e " ${PURPLE}Â» IP Server   :${WH} $IP_VPS"
    echo -e " ${PURPLE}Â» RAM Usage   :${WH} $RAM_USED / $RAM_TOTAL MB"
    echo -e " ${PURPLE}Â» Status VPN  :${WH} $STATUS_SRV"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e " ${BOLD}MENU UTAMA:${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${GREEN}[1]${NC} â€¢ Buat User Baru"
    echo -e "  ${GREEN}[2]${NC} â€¢ List User & Monitor"
    echo -e "  ${GREEN}[3]${NC} â€¢ Perpanjang User"
    echo -e "  ${GREEN}[4]${NC} â€¢ Hapus User"
    echo -e "  ${GREEN}[5]${NC} â€¢ Cek Service Log"
    echo -e "  ${GREEN}[6]${NC} â€¢ Auto Hapus Expired"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${RED}[0]${NC} â€¢ Exit / Keluar"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -ne " ${YELLOW}â‡¨  Pilih Menu [0-6]: ${NC}"
}

function add_user() {
    header
    echo -e " ${CYAN}CREATE NEW USER${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -p " Â» Username : " username
    if [[ -z "$username" ]]; then echo -e "\n${RED}âŒ Input tidak boleh kosong!${NC}"; sleep 1; return; fi
    
    # Cek Duplikat
    if jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then 
        echo -e "\n${RED}âŒ Username '$username' sudah ada!${NC}"; sleep 2; return; 
    fi
    
    read -p " Â» Password : " password 
    read -p " Â» Expired (hari) : " masa_aktif
    [ -z "$masa_aktif" ] && masa_aktif=30
    
    exp_date=$(date -d "+$masa_aktif days" +%Y-%m-%d)
    
    # Update Config.json
    cp "$CONFIG_FILE" "${CONFIG_FILE}.bak"
    jq --arg user "$username" '.auth.config += [$user]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
    
    # Update User-DB
    jq --arg u "$username" --arg e "$exp_date" --arg i "2" --arg q "0" \
       '.[$u] = {exp: $e, ip: $i, quota: $q}' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
    
    restart_service
    
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e " âœ… ${GREEN}User Berhasil Dibuat!${NC}"
    echo -e " ðŸ‘¤ User : ${WH}$username${NC}"
    echo -e " ðŸ“… Exp  : ${WH}$exp_date${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -n 1 -s -r -p "Tekan Enter untuk kembali..."
}

function list_users() {
    header
    echo -e " ${CYAN}LIST USER ZIVPN${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    # Header Tabel (Rapi)
    printf "${YELLOW}%-4s %-15s %-12s %-10s %s${NC}\n" "No" "Username" "Expired" "Status" "Quota"
    echo -e "${BLUE}--------------------------------------------------${NC}"
    
    count_user=$(jq '.auth.config | length' "$CONFIG_FILE")
    if [[ "$count_user" == "0" || "$count_user" == "null" ]]; then
         echo -e " ${RED}Data user kosong.${NC}"
    else
        no=1
        jq -r '.auth.config[]' "$CONFIG_FILE" | while read -r user; do
            if [[ -z "$user" || "$user" == "null" ]]; then continue; fi
            
            # Ambil data detail
            exp=$(jq -r --arg u "$user" '.[$u].exp // "Unknown"' "$USER_DB")
            quota=$(jq -r --arg u "$user" '.[$u].quota // "Unl"' "$USER_DB")
            
            # Logika Status Warna
            status_show="${GREEN}ACTIVE${NC}"
            if [[ "$exp" != "Unknown" ]]; then
                today=$(date +%Y-%m-%d)
                if [[ "$today" > "$exp" ]]; then 
                    status_show="${RED}EXPIRED${NC}"
                fi
            fi
            
            # Format Quota
            if [[ "$quota" == "0" || "$quota" == "Unl" ]]; then 
                quota_show="Unl"
            else 
                quota_show="${quota}GB"
            fi

            # Print dengan %b untuk menerjemahkan kode warna
            printf "%-4s %-15s %-12s %b %s\n" "$no" "$user" "$exp" "$status_show" "$quota_show"
            ((no++))
        done
    fi
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -n 1 -s -r -p "Tekan Enter untuk kembali..."
}

function renew_user() {
    header
    echo -e " ${CYAN}RENEW USER${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -p " Â» Username : " username
    
    if ! jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then 
        echo -e "\n${RED}âŒ User tidak ditemukan!${NC}"; sleep 1; return; 
    fi
    
    read -p " Â» Tambah Hari : " days
    curr_exp=$(jq -r --arg u "$username" '.[$u].exp' "$USER_DB")
    
    # Handle jika exp null
    if [[ "$curr_exp" == "null" || -z "$curr_exp" ]]; then curr_exp=$(date +%Y-%m-%d); fi
    
    new_exp=$(date -d "$curr_exp + $days days" +%Y-%m-%d)
    
    # Update DB
    jq --arg u "$username" --arg e "$new_exp" '.[$u].exp = $e' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
    
    echo -e "\n âœ… ${GREEN}Berhasil Diperpanjang!${NC}"
    echo -e " ðŸ“… Exp Baru: ${WH}$new_exp${NC}"
    read -n 1 -s -r -p "Tekan Enter untuk kembali..."
}

function del_user() {
    header
    echo -e " ${CYAN}DELETE USER${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    read -p " Â» Username : " username
    
    if jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then
        # Hapus dari config.json
        jq --arg user "$username" '.auth.config -= [$user]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
        # Hapus dari user-db.json
        jq --arg user "$username" 'del(.[$user])' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
        
        restart_service
        echo -e "\n âœ… ${GREEN}User $username telah dihapus.${NC}"
    else 
        echo -e "\n ${RED}âŒ User tidak ditemukan.${NC}"
    fi
    read -n 1 -s -r -p "Tekan Enter untuk kembali..."
}

function delete_expired() {
    header
    echo -e " ${CYAN}AUTO DELETE EXPIRED${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo " Memeriksa user expired..."
    
    today=$(date +%Y-%m-%d)
    users=$(jq -r 'keys[]' "$USER_DB")
    count=0
    
    for user in $users; do
        exp=$(jq -r --arg u "$user" '.[$u].exp' "$USER_DB")
        if [[ "$today" > "$exp" ]]; then
            echo -e " - Menghapus: ${RED}$user${NC} (Exp: $exp)"
            jq --arg u "$user" '.auth.config -= [$u]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
            jq --arg u "$user" 'del(.[$u])' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
            ((count++))
        fi
    done
    
    if [ $count -gt 0 ]; then
        restart_service
        echo -e "\n ${GREEN}âœ… Berhasil menghapus $count user expired.${NC}"
    else
        echo -e "\n ${GREEN}âœ… Tidak ada user expired.${NC}"
    fi
    read -n 1 -s -r -p "Tekan Enter untuk kembali..."
}

# --- MAIN LOOP ---
while true; do
    show_main_menu
    read -r choice
    case $choice in
        1) add_user ;;
        2) list_users ;;
        3) renew_user ;;
        4) del_user ;;
        5) clear; journalctl -u "$SERVICE_NAME" -f -n 20 ;;
        6) delete_expired ;;
        0) clear; exit 0 ;;
        *) echo -e "\n ${RED}Pilihan salah!${NC}"; sleep 1 ;;
    esac
done
EOF

# 7. Membuat Shortcut Command (Final)
echo -e "${GREEN}[6/8] Membuat Shortcut Command...${NC}"
chmod +x /usr/local/bin/zivpn-menu

# Buat shortcut: ketik 'zivpn' memanggil 'zivpn-menu'
ln -sf /usr/local/bin/zivpn-menu /usr/bin/zivpn
chmod +x /usr/bin/zivpn

# Bersihkan cache lokasi command
hash -r

# 8. Setup Systemd (Menggunakan zivpn-core)
echo -e "${GREEN}[7/8] Membuat Service...${NC}"
cat <<EOF > /etc/systemd/system/zivpn.service
[Unit]
Description=ZIVPN UDP Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn
ExecStart=/usr/local/bin/zivpn-core server -c /etc/zivpn/config.json
Restart=always
RestartSec=3
Environment=ZIVPN_LOG_LEVEL=info
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

# 9. Firewall & Start
echo -e "${GREEN}[8/8] Setup Firewall & Start...${NC}"
sysctl -w net.ipv4.ip_forward=1 > /dev/null 2>&1
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

NIC=$(ip -4 route ls|grep default|grep -Po '(?<=dev )(\S+)'|head -1)
iptables -t nat -F
iptables -t nat -A PREROUTING -i $NIC -p udp --dport 6000:19999 -j DNAT --to-destination :5667
iptables -A INPUT -p udp --dport 5667 -j ACCEPT
netfilter-persistent save > /dev/null 2>&1

systemctl daemon-reload
systemctl enable zivpn
systemctl restart zivpn

clear
echo -e "${BLUE}=================================================${NC}"
echo -e "${GREEN}      INSTALASI SELESAI & COMMAND SIAP            ${NC}"
echo -e "${BLUE}=================================================${NC}"
echo -e " - Menu SSH Lama Anda : Tetap ketik ${YELLOW}menu${NC}"
echo -e " - Menu ZiVPN Baru    : Ketik ${YELLOW}zivpn${NC}"
echo -e "${BLUE}=================================================${NC}"
