#!/bin/bash
# ==========================================
#  ZIVPN ALL-IN-ONE INSTALLER (CLEAN & PRO)
# ==========================================

# --- WARNA ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

clear
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "      ZIVPN AUTO-INSTALLER WITH SMART CLEANUP     "
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# ==========================================
#  1. PRE-INSTALL: CEK & HAPUS VERSI LAMA
# ==========================================
echo -e "\n${YELLOW}[1/6] Memeriksa Instalasi Sebelumnya...${NC}"

if [[ -f /etc/systemd/system/zivpn.service ]] || [[ -d /etc/zivpn ]]; then
    echo -e "   âš ï¸  Terdeteksi instalasi ZiVPN lama. Membersihkan..."
    
    # Matikan Service
    systemctl stop zivpn >/dev/null 2>&1
    systemctl disable zivpn >/dev/null 2>&1
    
    # Hapus File Service & Config
    rm -f /etc/systemd/system/zivpn.service
    rm -rf /etc/zivpn
    
    # Hapus Script Menu Lama
    rm -f /usr/local/sbin/zivpn-menu
    rm -f /usr/local/sbin/xp-zivpn
    
    # Bersihkan Cronjob Lama (Hanya baris xp-zivpn)
    if [ -f /var/spool/cron/crontabs/root ]; then
        sed -i '/xp-zivpn/d' /var/spool/cron/crontabs/root
    fi
    
    # Reload Systemd
    systemctl daemon-reload
    echo -e "   âœ… Instalasi lama berhasil dihapus."
else
    echo -e "   âœ… Tidak ada instalasi sebelumnya. Lanjut..."
fi

# ==========================================
#  2. INSTALL CORE ZIVPN
# ==========================================
echo -e "\n${GREEN}[2/6] Mengunduh & Menginstall Core ZiVPN...${NC}"
wget -q -O zi.sh https://raw.githubusercontent.com/zahidbd2/udp-zivpn/main/zi.sh
chmod +x zi.sh
./zi.sh >/dev/null 2>&1

# ==========================================
#  3. PERSIAPAN DATABASE
# ==========================================
echo -e "${GREEN}[3/6] Mempersiapkan Database...${NC}"
mkdir -p /etc/zivpn
# Buat database kosong jika belum ada (setelah clean install)
if [ ! -f "/etc/zivpn/user-db.json" ]; then
    echo "{}" > /etc/zivpn/user-db.json
fi
# Install tools pendukung
apt-get update -y >/dev/null 2>&1
apt-get install -y jq curl net-tools cron >/dev/null 2>&1

# ==========================================
#  4. SCRIPT AUTO-DELETE (EXP CHECKER)
# ==========================================
echo -e "${GREEN}[4/6] Memasang Sistem Auto-Delete (XP)...${NC}"
cat <<'EOF' > /usr/local/sbin/xp-zivpn
#!/bin/bash
CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"
SERVICE_NAME="zivpn.service"
now_sec=$(date +%s)

if [[ ! -f "$USER_DB" || ! -f "$CONFIG_FILE" ]]; then exit 0; fi
RESTART_REQUIRED=false

# Cek user expired
jq -r 'to_entries[] | "\(.key)|\(.value.exp)"' "$USER_DB" | while IFS='|' read -r username exp_date; do
    if [[ "$exp_date" == "null" || -z "$exp_date" ]]; then continue; fi
    exp_sec=$(date -d "$exp_date" +%s 2>/dev/null)
    if [[ $? -ne 0 ]]; then continue; fi
    
    if [[ $exp_sec -lt $now_sec ]]; then
        # Hapus user
        jq --arg u "$username" '.auth.config -= [$u]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
        jq --arg u "$username" 'del(.[$u])' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
        RESTART_REQUIRED=true
    fi
done

# Restart service jika ada yang dihapus
if [ "$RESTART_REQUIRED" = true ]; then systemctl restart "$SERVICE_NAME"; fi
EOF
chmod +x /usr/local/sbin/xp-zivpn

# Pasang Cronjob Baru
if ! grep -q "xp-zivpn" /var/spool/cron/crontabs/root 2>/dev/null; then
    echo "0 0 * * * /usr/local/sbin/xp-zivpn >> /var/log/xp-zivpn.log 2>&1" >> /var/spool/cron/crontabs/root
    service cron restart
fi

# ==========================================
#  5. MEMASANG MENU MANAGER PRO
# ==========================================
echo -e "${GREEN}[5/6] Memasang Menu Manager Pro...${NC}"
cat <<'EOF' > /usr/local/sbin/zivpn-menu
#!/bin/bash
CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"
SERVICE_NAME="zivpn.service"

RED='\e[1;31m'
GREEN='\e[1;32m'
YELLOW='\e[1;33m'
BLUE='\e[1;34m'
PURPLE='\e[1;35m'
CYAN='\e[1;36m'
NC='\e[0m'
WH='\e[1;37m'

function restart_service() { systemctl restart "$SERVICE_NAME"; }
function header() {
    clear
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${WH}      âš¡ ZIVPN PREMIUM MANAGER (ORIGINAL) âš¡       ${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

function add_user() {
    header
    # --- Input Data ---
    read -p " Â» Username : " username
    [ -z "$username" ] && return
    
    read -p " Â» Password : " password
    [ -z "$password" ] && password="$username" 
    
    read -p " Â» Expired (hari) : " masa_aktif
    [ -z "$masa_aktif" ] && masa_aktif=30
    
    read -p " Â» Quota (GB) : " quota
    [ -z "$quota" ] && quota="Unlimited"

    # --- Logic ---
    exp_date=$(date -d "+$masa_aktif days" +%Y-%m-%d)
    domain=$(cat /etc/xray/domain 2>/dev/null)
    [ -z "$domain" ] && domain=$(curl -s ipv4.icanhazip.com)
    IP=$(curl -s ipv4.icanhazip.com)
    
    # Get Port
    PORT=$(grep -o '"listen": *"[^"]*"' $CONFIG_FILE | cut -d'"' -f4 | sed 's/://g' | sed 's/0.0.0.0//g')
    [ -z "$PORT" ] && PORT="5667"

    # Save Config
    jq --arg user "$username" '.auth.config += [$user]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
    jq --arg u "$username" --arg e "$exp_date" --arg q "$quota" '.[$u] = {exp: $e, quota: $q}' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
    
    restart_service
    
    # --- OUTPUT KEREN ---
    clear
    echo -e "\033[1;93mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
    echo -e "ðŸ”µ  ZIVPN PREMIUM ACCOUNT   ðŸ”µ"
    echo -e "\033[1;93mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
    echo -e "âž¤ Domain    : $domain"
    echo -e "âž¤ IP        : $IP"
    echo -e "âž¤ Username  : $username"
    echo -e "âž¤ Password  : $password"
    echo -e "âž¤ Expired   : $exp_date"
    echo -e "âž¤ Quota     : $quota GB"
    echo -e "\033[1;93mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
    echo -e "âž¤ Port UDP  : $PORT"
    echo -e "âž¤ UDP Custom: 1-65535 (All Port)"
    echo -e "\033[1;93mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
    echo -e "CARA PAKAI     : "
    echo -e "UDP SERVER   Isi Dengan      : $domain"
    echo -e "UDP PASSWORD Isi dengan      : $username"
    echo -e "\033[1;93mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m"
    echo -e "    \033[5m\033[35mTHANKS YOU FOR \033[34mUSING SCRIPT \033[31mHOKAGE LEGEND\033[0m"
    echo -e ""
    read -n 1 -s -r -p "Press any key to back on menu"
}

function list_users() {
    header
    printf "${YELLOW}%-4s %-15s %-12s %s${NC}\n" "No" "Username" "Expired" "Quota"
    echo -e "${BLUE}---------------------------------------------${NC}"
    no=1
    jq -r '.auth.config[]' "$CONFIG_FILE" | while read -r user; do
        exp=$(jq -r --arg u "$user" '.[$u].exp // "Unknown"' "$USER_DB")
        quota=$(jq -r --arg u "$user" '.[$u].quota // "Unlimited"' "$USER_DB")
        printf "%-4s %-15s %-12s %s\n" "$no" "$user" "$exp" "$quota"
        ((no++))
    done
    read -n 1 -s -r -p "Tekan Enter..."
}

function show_main_menu() {
    header
    PORT=$(grep -o '"listen": *"[^"]*"' $CONFIG_FILE | cut -d'"' -f4 | sed 's/://g' | sed 's/0.0.0.0//g')
    [ -z "$PORT" ] && PORT="5667"
    IP_VPS=$(curl -s --connect-timeout 2 ipv4.icanhazip.com)
    STATUS_SRV=$(systemctl is-active "$SERVICE_NAME" | tr '[:lower:]' '[:upper:]')
    [ "$STATUS_SRV" == "ACTIVE" ] && STATUS_SRV="${GREEN}RUNNING${NC}" || STATUS_SRV="${RED}STOPPED${NC}"
    echo -e " ${PURPLE}Â» IP Server    :${WH} $IP_VPS"
    echo -e " ${PURPLE}Â» Port UDP     :${WH} $PORT"
    echo -e " ${PURPLE}Â» Status       :${WH} $STATUS_SRV"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${GREEN}[1]${NC} â€¢ Buat User Baru"
    echo -e "  ${GREEN}[2]${NC} â€¢ List User"
    echo -e "  ${GREEN}[3]${NC} â€¢ Hapus User"
    echo -e "  ${GREEN}[4] â€¢ Cek Log Service"
    echo -e "  ${GREEN}[5] â€¢ Sync User SSH (System -> ZiVPN)"
    echo -e "  ${GREEN}[6] â€¢ Fix UDP Custom (Exclude Port)"
    echo -e "  ${GREEN}[7] â€¢ Paksa Hapus User Expired"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${GREEN}[0]${NC} â€¢ Kembali ke Menu Utama"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -ne " ${YELLOW}â‡¨  Pilih Menu: ${NC}"
}

function fix_udp() {
    PORT=$(grep -o '"listen": *"[^"]*"' $CONFIG_FILE | cut -d'"' -f4 | sed 's/://g' | sed 's/0.0.0.0//g')
    [ -z "$PORT" ] && PORT="5667"
    if [ -f "/etc/systemd/system/udp-custom.service" ]; then
        sed -i "s|server -exclude .*|server -exclude 22,53,68,$PORT|g" /etc/systemd/system/udp-custom.service
        systemctl daemon-reload
        systemctl restart udp-custom
        echo "âœ… UDP Custom Updated."; sleep 1
    fi
}
function sync_ssh() {
    header
    echo -e " Syncing..."
    while IFS=: read -r username _ uid _ _ _ _; do
        if [[ $uid -ge 1000 && "$username" != "nobody" ]]; then
            if ! jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then
                jq --arg user "$username" '.auth.config += [$user]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
                jq --arg u "$username" --arg e "2099-12-31" '.[$u] = {exp: $e}' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
            fi
        fi
    done < /etc/passwd
    restart_service
    echo -e "âœ… Selesai!"; sleep 1
}

while true; do
    show_main_menu
    read -r choice
    case $choice in
        1) add_user ;; 
        2) list_users ;; 
        3) header; read -p "User: " u; jq --arg u "$u" '.auth.config -= [$u]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"; restart_service ;;
        5) sync_ssh ;; 
        6) fix_udp ;; 
        7) /usr/local/sbin/xp-zivpn; echo "Selesai."; sleep 2 ;;
        0) menu ;; 
        *) sleep 1 ;;
    esac
done
EOF
chmod +x /usr/local/sbin/zivpn-menu

# ==========================================
#  6. FINALISASI & FIX UDP EXCLUDE
# ==========================================
echo -e "\n${GREEN}[6/6] Membersihkan & Restarting Services...${NC}"

# Ambil Port ZiVPN Terbaru
PORT_ZIVPN=$(grep -o '"listen": *"[^"]*"' /etc/zivpn/config.json | cut -d'"' -f4 | sed 's/://g' | sed 's/0.0.0.0//g')
[ -z "$PORT_ZIVPN" ] && PORT_ZIVPN="5667"

# Fix Exclude Port di UDP Custom agar tidak bentrok
if [ -f "/etc/systemd/system/udp-custom.service" ]; then
    sed -i "s|server -exclude .*|server -exclude 22,53,68,$PORT_ZIVPN|g" /etc/systemd/system/udp-custom.service
    systemctl daemon-reload
    systemctl restart udp-custom
fi

rm -f zi.sh
clear
echo "============================================"
echo "      INSTALLASI SELESAI & AKTIF"
echo "============================================"
echo " - ZiVPN Service : RUNNING"
echo " - UDP Custom    : RUNNING"
echo " - Auto Expired  : ACTIVE (Setiap 00:00)"
echo " - Menu Pro      : Ketik 'zivpn-menu'"
echo "============================================"
