#!/bin/bash
# ==========================================
#  ZIVPN ULTIMATE INSTALLER (FIXED REBOOT)
#  Based on Official v1.4.9 + Hokage Manager
# ==========================================

# --- WARNA ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

clear
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "      ZIVPN INSTALLER & FIXER (PERMANENT)      "
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# ==========================================
#  1. INSTALL DEPENDENCIES (PENTING)
# ==========================================
echo -e "\n${YELLOW}[1/6] Menginstall Paket Wajib...${NC}"
apt-get update -y
# Install iptables-persistent agar rule tidak hilang saat reboot
DEBIAN_FRONTEND=noninteractive apt-get install -y iptables iptables-persistent netfilter-persistent jq curl openssl cron > /dev/null 2>&1
echo -e "   âœ… Dependencies terinstall."

# ==========================================
#  2. STOP & BERSIHKAN LAMA
# ==========================================
echo -e "\n${YELLOW}[2/6] Membersihkan Service Lama...${NC}"
systemctl stop zivpn.service >/dev/null 2>&1
systemctl disable zivpn.service >/dev/null 2>&1
# Kita tidak menghapus config.json dan user-db.json agar data user aman
# Kecuali binary dan service file
rm -f /usr/local/bin/zivpn
rm -f /etc/systemd/system/zivpn.service

# ==========================================
#  3. DOWNLOAD CORE (SESUAI SCRIPT ASLI)
# ==========================================
echo -e "\n${GREEN}[3/6] Mengunduh Binary ZiVPN v1.4.9...${NC}"
wget -q https://github.com/zahidbd2/udp-zivpn/releases/download/udp-zivpn_1.4.9/udp-zivpn-linux-amd64 -O /usr/local/bin/zivpn
chmod +x /usr/local/bin/zivpn

# Cek Folder Config
mkdir -p /etc/zivpn >/dev/null 2>&1

# Download Config Default HANYA JIKA BELUM ADA
if [ ! -f "/etc/zivpn/config.json" ]; then
    echo -e "   âš ï¸ Config tidak ditemukan, mengunduh baru..."
    wget -q https://raw.githubusercontent.com/zahidbd2/udp-zivpn/main/config.json -O /etc/zivpn/config.json
    
    # Generate Certs (Sesuai Script Asli)
    echo -e "   ðŸ” Generating Certificates..."
    openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=ID/ST=Jawa/L=Jakarta/O=Hokage/OU=Store/CN=zivpn" -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" >/dev/null 2>&1
else
    echo -e "   âœ… Config lama ditemukan, data user aman."
fi

# Buat DB User jika tidak ada (Untuk Script Manager)
if [ ! -f "/etc/zivpn/user-db.json" ]; then
    echo "{}" > /etc/zivpn/user-db.json
fi

# ==========================================
#  4. SYSTEM TUNING (PERMANENT FIX)
# ==========================================
echo -e "\n${GREEN}[4/6] Mengatur Network Buffer (Permanent)...${NC}"
# Tulis ke sysctl.conf agar load saat reboot
grep -q "net.core.rmem_max" /etc/sysctl.conf || echo "net.core.rmem_max=16777216" >> /etc/sysctl.conf
grep -q "net.core.wmem_max" /etc/sysctl.conf || echo "net.core.wmem_max=16777216" >> /etc/sysctl.conf
sysctl -p >/dev/null 2>&1

# ==========================================
#  5. SETUP SERVICE (FIXED PATH)
# ==========================================
echo -e "\n${GREEN}[5/6] Membuat Service Systemd...${NC}"
cat <<EOF > /etc/systemd/system/zivpn.service
[Unit]
Description=zivpn VPN Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn
# Pastikan path sesuai dengan lokasi download tadi (/usr/local/bin/zivpn)
ExecStart=/usr/local/bin/zivpn server -c /etc/zivpn/config.json
Restart=always
RestartSec=3
Environment=ZIVPN_LOG_LEVEL=info
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable zivpn.service
systemctl start zivpn.service

# ==========================================
#  6. FIREWALL & PORT REDIRECT (PERMANENT)
# ==========================================
echo -e "\n${GREEN}[6/6] Mengatur Firewall & Port...${NC}"

# Ambil Interface Utama (misal: eth0)
IFACE=$(ip -4 route ls|grep default|grep -Po '(?<=dev )(\S+)'|head -1)

# Hapus rule lama agar tidak duplikat
iptables -t nat -D PREROUTING -i $IFACE -p udp --dport 6000:19999 -j DNAT --to-destination :5667 >/dev/null 2>&1

# Pasang Rule Baru
iptables -t nat -A PREROUTING -i $IFACE -p udp --dport 6000:19999 -j DNAT --to-destination :5667

# IZINKAN PORT DI UFW (Jika aktif)
if command -v ufw > /dev/null; then
    ufw allow 6000:19999/udp >/dev/null 2>&1
    ufw allow 5667/udp >/dev/null 2>&1
fi

# SIMPAN RULE AGAR TIDAK HILANG SAAT REBOOT (KUNCI UTAMA)
netfilter-persistent save >/dev/null 2>&1
netfilter-persistent reload >/dev/null 2>&1

# ==========================================
#  FINISH
# ==========================================
# Restore XP Script & Cronjob (Memastikan fitur auto delete tetap jalan)
cat <<'EOF' > /usr/local/sbin/xp-zivpn
#!/bin/bash
CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"
SERVICE_NAME="zivpn.service"
now_sec=$(date +%s)
if [[ ! -f "$USER_DB" ]]; then exit 0; fi
RESTART=false
jq -r 'to_entries[] | "\(.key)|\(.value.exp)"' "$USER_DB" | while IFS='|' read -r u exp; do
    if [[ "$exp" == "null" || -z "$exp" ]]; then continue; fi
    exp_sec=$(date -d "$exp" +%s 2>/dev/null)
    if [[ $? -eq 0 && $exp_sec -lt $now_sec ]]; then
        jq --arg user "$u" '.auth.config -= [$user]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
        jq --arg user "$u" 'del(.[$user])' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
        RESTART=true
    fi
done
if [ "$RESTART" = true ]; then systemctl restart "$SERVICE_NAME"; fi
EOF
chmod +x /usr/local/sbin/xp-zivpn

# Cronjob Setup
sed -i '/xp-zivpn/d' /var/spool/cron/crontabs/root
echo "0 0 * * * /usr/local/sbin/xp-zivpn >> /var/log/xp-zivpn.log 2>&1" >> /var/spool/cron/crontabs/root

clear
echo "========================================================"
echo "      âœ… ZIVPN BERHASIL DIPERBAIKI & DIINSTALL âœ…      "
echo "========================================================"
echo " - Service Status  : $(systemctl is-active zivpn)"
echo " - Auto Start      : AKTIF (Aman saat Reboot)"
echo " - Port Redirect   : 6000-19999 -> 5667 (PERMANENT)"
echo " - Config Path     : /etc/zivpn/config.json"
echo " - Binary Path     : /usr/local/bin/zivpn"
echo "========================================================"
