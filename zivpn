#!/bin/bash
# ==========================================
#   ZIVPN AUTO INSTALLER PREMIUM (FINAL FIX)
#   Fixed: Binary Rename & Command Path
# ==========================================

# Warna
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

clear
echo -e "${BLUE}=================================================${NC}"
echo -e "${YELLOW}       INSTALLER ZIVPN PREMIUM (FINAL)          ${NC}"
echo -e "${BLUE}=================================================${NC}"
echo ""

# 1. Update & Install Dependencies
echo -e "${GREEN}[1/8] Update Repository & Install Tools...${NC}"
apt-get update -y > /dev/null 2>&1
apt-get install -y wget curl jq openssl net-tools bc iptables-persistent > /dev/null 2>&1

# 2. Stop Service Lama & Bersihkan File Konflik
systemctl stop zivpn > /dev/null 2>&1
rm -f /usr/local/bin/zivpn       # Hapus binary lama yang namanya bentrok
rm -f /usr/bin/zivpn             # Hapus shortcut lama

# 3. Download Binary ZIVPN (Disimpan sbg zivpn-core)
echo -e "${GREEN}[2/8] Download Core ZIVPN...${NC}"
wget -q https://github.com/zahidbd2/udp-zivpn/releases/download/udp-zivpn_1.4.9/udp-zivpn-linux-amd64 -O /usr/local/bin/zivpn-core
chmod +x /usr/local/bin/zivpn-core

# 4. Setup Config & Database
echo -e "${GREEN}[3/8] Mengkonfigurasi Database...${NC}"
mkdir -p /etc/zivpn

# Backup config lama
if [ -f /etc/zivpn/config.json ]; then
    cp /etc/zivpn/config.json /etc/zivpn/config.json.backup
fi

# Generate Certificate
rm -f /etc/zivpn/zivpn.crt /etc/zivpn/zivpn.key
openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=ID/ST=Jakarta/L=Jakarta/O=ZIVPN/OU=Premium/CN=zivpn" -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" > /dev/null 2>&1

# Buat Config Utama
cat <<EOF > /etc/zivpn/config.json
{
  "listen": ":5667",
  "cert": "/etc/zivpn/zivpn.crt",
  "key": "/etc/zivpn/zivpn.key",
  "obfs": "zivpn",
  "auth": {
    "mode": "passwords",
    "config": []
  }
}
EOF

# User DB
if [ ! -f /etc/zivpn/user-db.json ]; then
    echo "{}" > /etc/zivpn/user-db.json
fi

# 5. Auto-Sync User SSH
echo -e "${GREEN}[4/8] Sinkronisasi User SSH ke ZIVPN...${NC}"
SSH_DB="/etc/ssh/.ssh.db"
CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"

if [ -f "$SSH_DB" ]; then
    grep "^#ssh#" "$SSH_DB" | while read -r line; do
        user=$(echo $line | awk '{print $2}')
        quota=$(echo $line | awk '{print $4}')
        ip=$(echo $line | awk '{print $5}')
        exp_raw=$(echo $line | cut -d ' ' -f 6-)
        exp_date=$(date -d "$exp_raw" +%Y-%m-%d 2>/dev/null)
        if [[ -z "$exp_date" ]]; then exp_date=$(date +%Y-%m-%d); fi

        if [[ -n "$user" ]]; then
            cp "$CONFIG_FILE" "${CONFIG_FILE}.tmp"
            jq --arg u "$user" '.auth.config += [$u]' "${CONFIG_FILE}.tmp" > "$CONFIG_FILE"
            
            [ -z "$quota" ] && quota=0
            [ -z "$ip" ] && ip=2
            cp "$USER_DB" "${USER_DB}.tmp"
            jq --arg u "$user" --arg e "$exp_date" --arg i "$ip" --arg q "$quota" \
               '.[$u] = {exp: $e, ip: $i, quota: $q}' "${USER_DB}.tmp" > "$USER_DB"
        fi
    done
fi

# Default User
cp "$CONFIG_FILE" "${CONFIG_FILE}.tmp"
jq '.auth.config += ["zivpn"]' "${CONFIG_FILE}.tmp" > "$CONFIG_FILE"
rm -f /etc/zivpn/*.tmp

# 6. Install Menu (Disimpan sbg zivpn-menu)
echo -e "${GREEN}[5/8] Menginstall Menu Manager V3...${NC}"
cat << 'EOF' > /usr/local/bin/zivpn-menu
#!/bin/bash
# ZIVPN MENU MANAGER - V3 FIXED

CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"
SERVICE_NAME="zivpn.service"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
WH='\033[1;37m'

function restart_service() { systemctl restart "$SERVICE_NAME"; }

function show_main_menu() {
    clear
    if [ -f /etc/os-release ]; then MODEL2=$(cat /etc/os-release | grep -w PRETTY_NAME | head -n1 | sed 's/[=PRETTY_NAME"]//g'); else MODEL2="Linux OS"; fi
    if free -h | grep -q "MiB"; then tram=$(free -h | awk '/Mem:/ {print $2}'); uram=$(free -h | awk '/Mem:/ {print $3}'); else tram=$(free -m | awk '/Mem:/ {print $2 "MB"}'); uram=$(free -m | awk '/Mem:/ {print $3 "MB"}'); fi
    IP_VPS=$(curl -s --connect-timeout 2 ipv4.icanhazip.com)
    if systemctl is-active --quiet "$SERVICE_NAME"; then status_zivpn="${GREEN}ON${NC}"; else status_zivpn="${RED}OFF${NC}"; fi
    
    echo -e "${GREEN}â•­â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•®${NC}"
    echo -e "${GREEN}â”‚${NC} ${WH}            â€¢ ZIVPN PREMIUM MANAGER â€¢            ${NC} ${GREEN}â”‚${NC}"
    echo -e "${GREEN}â•°â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¯${NC}"
    echo -e "${GREEN}â•­â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•®${NC}"
    echo -e "${GREEN}â”‚ ${WH}OS System      : ${GREEN}$MODEL2${NC}"
    echo -e "${GREEN}â”‚ ${WH}IP VPS         : ${CYAN}$IP_VPS${NC}"
    echo -e "${GREEN}â”‚ ${WH}RAM Usage      : ${CYAN}$uram / $tram${NC}"
    echo -e "${GREEN}â•°â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¯${NC}"
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘${CYAN}         ðŸš€   S T A T U S   S E R V I C E   ðŸš€        ${BLUE}â•‘${NC}"
    echo -e "${BLUE}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${BLUE}â•‘  ${WH}VPN UDP: $status_zivpn   ${WH}|   ${WH}VER: 1.4.9              ${BLUE}â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}â•­â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•®${NC}"
    echo -e "${GREEN}â”‚                    ${WH}MENU UTAMA${NC}                     ${GREEN}â”‚${NC}"
    echo -e "${GREEN}â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤${NC}"
    echo -e "${GREEN}â”‚ ${WH}[1] Buat User Baru (SSH/UDP)      ${WH}[4] Hapus User       ${GREEN}â”‚${NC}"
    echo -e "${GREEN}â”‚ ${WH}[2] List User & Info Detail       ${WH}[5] Cek Service      ${GREEN}â”‚${NC}"
    echo -e "${GREEN}â”‚ ${WH}[3] Perpanjang Masa Aktif         ${WH}[6] Hapus Expired    ${GREEN}â”‚${NC}"
    echo -e "${GREEN}â”‚ ${WH}                                  ${WH}[0] Exit             ${GREEN}â”‚${NC}"
    echo -e "${GREEN}â•°â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¯${NC}"
    echo -ne "  ${WH}Masukkan pilihan Anda [0-6]: ${NC}"
}

function add_user() {
    echo -e "\n${CYAN}[ Membuat User ZIVPN Baru ]${NC}"
    read -p "Masukkan Username/Password : " username
    if [[ -z "$username" ]]; then echo -e "${RED}Input kosong!${NC}"; sleep 1; return; fi
    if jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then echo -e "${RED}User sudah ada!${NC}"; sleep 1; return; fi
    read -p "Masa Aktif (hari)          : " masa_aktif
    [ -z "$masa_aktif" ] && masa_aktif=30
    exp_date=$(date -d "+$masa_aktif days" +%Y-%m-%d)
    cp "$CONFIG_FILE" "${CONFIG_FILE}.bak"
    jq --arg user "$username" '.auth.config += [$user]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
    jq --arg u "$username" --arg e "$exp_date" --arg i "2" --arg q "0" '.[$u] = {exp: $e, ip: $i, quota: $q}' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
    restart_service
    echo -e "${GREEN}User $username Berhasil Dibuat!${NC}"
    read -n 1 -s -r -p "Enter..."
}

function list_users() {
    echo -e "\n${CYAN}[ List User ZIVPN ]${NC}"
    echo -e "${GREEN}==============================================================${NC}"
    printf "${WH}%-4s %-15s %-12s %-10s %-10s${NC}\n" "No" "Username" "Expired" "Limit IP" "Quota"
    echo -e "${GREEN}==============================================================${NC}"
    count_user=$(jq '.auth.config | length' "$CONFIG_FILE")
    if [[ "$count_user" == "0" || "$count_user" == "null" ]]; then
         echo -e "${YELLOW}   Belum ada user.${NC}"
    else
        no=1
        jq -r '.auth.config[]' "$CONFIG_FILE" | while read -r user; do
            if [[ -z "$user" || "$user" == "null" ]]; then continue; fi
            exp=$(jq -r --arg u "$user" '.[$u].exp // "Unknown"' "$USER_DB")
            ip=$(jq -r --arg u "$user" '.[$u].ip // "No Limit"' "$USER_DB")
            quota=$(jq -r --arg u "$user" '.[$u].quota // "No Limit"' "$USER_DB")
            status_exp="${GREEN}(ON)${NC}"
            if [[ "$exp" != "Unknown" ]]; then
                today=$(date +%Y-%m-%d); if [[ "$today" > "$exp" ]]; then status_exp="${RED}(EXP)${NC}"; fi
            fi
            printf "%-4s %-15s %-12s %-10s %-10s %s\n" "$no" "$user" "$exp" "$ip" "${quota}GB" "$status_exp"
            ((no++))
        done
    fi
    echo -e "${GREEN}==============================================================${NC}"
    read -n 1 -s -r -p "Enter..."
}

function del_user() {
    echo -e "\n${CYAN}[ Hapus User ]${NC}"
    read -p "Username : " username
    if jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then
        jq --arg user "$username" '.auth.config -= [$user]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
        jq --arg user "$username" 'del(.[$user])' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
        restart_service; echo -e "${GREEN}User dihapus.${NC}"
    else echo -e "${RED}User tidak ditemukan.${NC}"; fi
    read -n 1 -s -r -p "Enter..."
}

function renew_user() {
    echo -e "\n${CYAN}[ Renew User ]${NC}"
    read -p "Username : " username
    if ! jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then echo -e "${RED}User tidak ditemukan!${NC}"; sleep 1; return; fi
    read -p "Tambah (hari): " days
    curr_exp=$(jq -r --arg u "$username" '.[$u].exp' "$USER_DB")
    if [[ "$curr_exp" == "null" || -z "$curr_exp" ]]; then curr_exp=$(date +%Y-%m-%d); fi
    new_exp=$(date -d "$curr_exp + $days days" +%Y-%m-%d)
    jq --arg u "$username" --arg e "$new_exp" '.[$u].exp = $e' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
    echo -e "${GREEN}Exp baru: $new_exp${NC}"; read -n 1 -s -r -p "Enter..."
}

function delete_expired() {
    echo -e "\n${CYAN}[ Hapus Expired ]${NC}"
    today=$(date +%Y-%m-%d); users=$(jq -r 'keys[]' "$USER_DB"); count=0
    for user in $users; do
        exp=$(jq -r --arg u "$user" '.[$u].exp' "$USER_DB")
        if [[ "$today" > "$exp" ]]; then
            jq --arg u "$user" '.auth.config -= [$u]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
            jq --arg u "$user" 'del(.[$u])' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
            ((count++))
        fi
    done
    [ $count -gt 0 ] && restart_service; echo -e "${GREEN}Selesai.${NC}"; read -n 1 -s -r -p "Enter..."
}

while true; do
    show_main_menu
    read -r choice
    case $choice in
        1) add_user ;; 2) list_users ;; 3) renew_user ;; 4) del_user ;; 5) clear; journalctl -u "$SERVICE_NAME" -f -n 20 ;; 6) delete_expired ;; 0) exit 0 ;; *) sleep 1 ;;
    esac
done
EOF

# 7. Membuat Shortcut Command (Final)
echo -e "${GREEN}[6/8] Membuat Shortcut Command...${NC}"
chmod +x /usr/local/bin/zivpn-menu

# Buat shortcut: ketik 'zivpn' memanggil 'zivpn-menu'
ln -sf /usr/local/bin/zivpn-menu /usr/bin/zivpn
chmod +x /usr/bin/zivpn

# Bersihkan cache lokasi command
hash -r

# 8. Setup Systemd (Menggunakan zivpn-core)
echo -e "${GREEN}[7/8] Membuat Service...${NC}"
cat <<EOF > /etc/systemd/system/zivpn.service
[Unit]
Description=ZIVPN UDP Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn
ExecStart=/usr/local/bin/zivpn-core server -c /etc/zivpn/config.json
Restart=always
RestartSec=3
Environment=ZIVPN_LOG_LEVEL=info
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

# 9. Firewall & Start
echo -e "${GREEN}[8/8] Setup Firewall & Start...${NC}"
sysctl -w net.ipv4.ip_forward=1 > /dev/null 2>&1
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

NIC=$(ip -4 route ls|grep default|grep -Po '(?<=dev )(\S+)'|head -1)
iptables -t nat -F
iptables -t nat -A PREROUTING -i $NIC -p udp --dport 6000:19999 -j DNAT --to-destination :5667
iptables -A INPUT -p udp --dport 5667 -j ACCEPT
netfilter-persistent save > /dev/null 2>&1

systemctl daemon-reload
systemctl enable zivpn
systemctl restart zivpn

clear
echo -e "${BLUE}=================================================${NC}"
echo -e "${GREEN}      INSTALASI SELESAI & COMMAND SIAP           ${NC}"
echo -e "${BLUE}=================================================${NC}"
echo -e " - Menu SSH Lama Anda : Tetap ketik ${YELLOW}menu${NC}"
echo -e " - Menu ZiVPN Baru    : Ketik ${YELLOW}zivpn${NC}"
echo -e "${BLUE}=================================================${NC}"
