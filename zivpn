#!/bin/bash
# ZIVPN MENU INSTALLER
# Compatible with: Original Zahid Islam Script

# 1. Install Dependencies (Wajib untuk Menu)
echo "Menginstall kebutuhan menu (jq)..."
apt-get update -y
apt-get install -y jq curl net-tools

# 2. Buat Database Expired (Karena script asli tidak punya)
if [ ! -f "/etc/zivpn/user-db.json" ]; then
    echo "{}" > /etc/zivpn/user-db.json
fi

# 3. Download/Buat Script Menu
cat <<'EOF' > /usr/local/sbin/zivpn-menu
#!/bin/bash
# ==========================================
#  ZIVPN MENU MANAGER V6 (ORIGINAL VERSION)
# ==========================================

# Konfigurasi File (Sesuai Installer Asli)
CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"
SERVICE_NAME="zivpn.service"

# Warna
RED='\e[1;31m'
GREEN='\e[1;32m'
YELLOW='\e[1;33m'
BLUE='\e[1;34m'
PURPLE='\e[1;35m'
CYAN='\e[1;36m'
NC='\e[0m'
WH='\e[1;37m'

function restart_service() { 
    systemctl restart "$SERVICE_NAME"
}

function header() {
    clear
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${WH}      âš¡ ZIVPN PREMIUM MANAGER (ORIGINAL) âš¡      ${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

function show_main_menu() {
    header
    # Ambil Port Langsung dari Config Asli
    PORT=$(grep -o '"listen": *"[^"]*"' $CONFIG_FILE | cut -d'"' -f4 | sed 's/://g' | sed 's/0.0.0.0//g')
    [ -z "$PORT" ] && PORT="5667" # Fallback

    IP_VPS=$(curl -s --connect-timeout 2 ipv4.icanhazip.com)
    if systemctl is-active --quiet "$SERVICE_NAME"; then 
        STATUS_SRV="${GREEN}RUNNING${NC}"
    else 
        STATUS_SRV="${RED}STOPPED${NC}"
    fi

    echo -e " ${PURPLE}Â» IP Server   :${WH} $IP_VPS"
    echo -e " ${PURPLE}Â» Port UDP    :${WH} $PORT"
    echo -e " ${PURPLE}Â» Status      :${WH} $STATUS_SRV"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${GREEN}[1]${NC} â€¢ Buat User Baru"
    echo -e "  ${GREEN}[2]${NC} â€¢ List User"
    echo -e "  ${GREEN}[3]${NC} â€¢ Hapus User"
    echo -e "  ${GREEN}[4]${NC} â€¢ Perpanjang User"
    echo -e "  ${GREEN}[5]${NC} â€¢ Cek Log Service"
    echo -e "  ${GREEN}[6]${NC} â€¢ Sync User SSH (System -> ZiVPN)"
    echo -e "  ${GREEN}[7]${NC} â€¢ Fix UDP Custom (Exclude Port)"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${RED}[0]${NC} â€¢ Keluar"
    echo -ne " ${YELLOW}â‡¨  Pilih Menu: ${NC}"
}

function add_user() {
    header
    echo -e " ${CYAN}CREATE NEW USER${NC}"
    read -p " Â» Username : " username
    if [[ -z "$username" ]]; then return; fi
    
    # Cek Duplikat di Config Asli
    if jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then 
        echo -e "\n${RED}âŒ Username '$username' sudah ada!${NC}"; sleep 2; return; 
    fi
    
    read -p " Â» Expired (hari) : " masa_aktif
    [ -z "$masa_aktif" ] && masa_aktif=30
    exp_date=$(date -d "+$masa_aktif days" +%Y-%m-%d)
    
    # Update Config Asli (Tambah Username ke Array)
    jq --arg user "$username" '.auth.config += [$user]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
    
    # Update Database Expired
    jq --arg u "$username" --arg e "$exp_date" '.[$u] = {exp: $e}' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
    
    restart_service
    echo -e "\nâœ… User ${GREEN}$username${NC} berhasil dibuat!"
    echo -e "ðŸ“… Expired: $exp_date"
    read -n 1 -s -r -p "Tekan Enter..."
}

function list_users() {
    header
    printf "${YELLOW}%-4s %-15s %-12s %s${NC}\n" "No" "Username" "Expired" "Status"
    echo -e "${BLUE}---------------------------------------------${NC}"
    
    no=1
    # Loop Array dari Config Asli
    jq -r '.auth.config[]' "$CONFIG_FILE" | while read -r user; do
        if [[ -z "$user" || "$user" == "null" ]]; then continue; fi
        
        # Ambil Expired dari DB Tambahan
        exp=$(jq -r --arg u "$user" '.[$u].exp // "Unknown"' "$USER_DB")
        
        status="${GREEN}ACTIVE${NC}"
        if [[ "$exp" != "Unknown" ]]; then
            if [[ $(date +%Y-%m-%d) > "$exp" ]]; then status="${RED}EXPIRED${NC}"; fi
        fi

        printf "%-4s %-15s %-12s %b\n" "$no" "$user" "$exp" "$status"
        ((no++))
    done
    read -n 1 -s -r -p "Tekan Enter..."
}

function del_user() {
    header
    read -p " Â» Username yang dihapus : " username
    
    if jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then
        # Hapus dari Config Asli
        jq --arg user "$username" '.auth.config -= [$user]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
        # Hapus dari DB Expired
        jq --arg user "$username" 'del(.[$user])' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
        
        restart_service
        echo -e "\nâœ… User $username dihapus."
    else 
        echo -e "\nâŒ User tidak ditemukan."
    fi
    read -n 1 -s -r -p "Tekan Enter..."
}

function renew_user() {
    header
    read -p " Â» Username : " username
    if ! jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then 
        echo -e "\nâŒ User tidak ditemukan!"; sleep 1; return; 
    fi
    
    read -p " Â» Tambah Hari : " days
    curr_exp=$(jq -r --arg u "$username" '.[$u].exp' "$USER_DB")
    if [[ "$curr_exp" == "null" || -z "$curr_exp" || "$curr_exp" == "Unknown" ]]; then curr_exp=$(date +%Y-%m-%d); fi
    new_exp=$(date -d "$curr_exp + $days days" +%Y-%m-%d)
    
    jq --arg u "$username" --arg e "$new_exp" '.[$u].exp = $e' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
    echo -e "\nâœ… Diperpanjang sampai: $new_exp"
    read -n 1 -s -r -p "Tekan Enter..."
}

function sync_ssh() {
    header
    echo -e " Syncing Linux Users to ZiVPN..."
    count=0
    while IFS=: read -r username _ uid _ _ _ _; do
        if [[ $uid -ge 1000 && "$username" != "nobody" ]]; then
            # Cek Expired System
            raw_exp=$(chage -l "$username" | grep "Account expires" | cut -d: -f2)
            if [[ "$raw_exp" == *"never"* || -z "$raw_exp" ]]; then exp="2099-12-31"; else exp=$(date -d "$raw_exp" +%Y-%m-%d 2>/dev/null); fi
            [ -z "$exp" ] && exp="2099-12-31"

            # Jika belum ada di ZiVPN, tambahkan
            if ! jq -e ".auth.config | index(\"$username\")" "$CONFIG_FILE" > /dev/null; then
                echo -e " + Adding: $username"
                jq --arg user "$username" '.auth.config += [$user]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
                jq --arg u "$username" --arg e "$exp" '.[$u] = {exp: $e}' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
                ((count++))
            fi
        fi
    done < /etc/passwd
    
    if [ $count -gt 0 ]; then restart_service; echo -e "\nâœ… $count user disinkronkan."; else echo -e "\nâœ… Tidak ada user baru."; fi
    read -n 1 -s -r -p "Tekan Enter..."
}

function fix_udp_custom() {
    header
    PORT=$(grep -o '"listen": *"[^"]*"' $CONFIG_FILE | cut -d'"' -f4 | sed 's/://g' | sed 's/0.0.0.0//g')
    [ -z "$PORT" ] && PORT="5667"
    
    echo " Mengecek UDP Custom..."
    if [ -f "/etc/systemd/system/udp-custom.service" ]; then
        echo " Menambahkan exclude port $PORT..."
        sed -i "s|server -exclude .*|server -exclude 22,53,68,$PORT|g" /etc/systemd/system/udp-custom.service
        systemctl daemon-reload
        systemctl restart udp-custom
        echo " âœ… Selesai. UDP Custom tidak akan menabrak ZiVPN."
    else
        echo " â„¹ï¸ UDP Custom tidak terinstall. Aman."
    fi
    read -n 1 -s -r -p "Tekan Enter..."
}

# --- LOOP ---
while true; do
    show_main_menu
    read -r choice
    case $choice in
        1) add_user ;;
        2) list_users ;;
        3) del_user ;;
        4) renew_user ;;
        5) clear; journalctl -u "$SERVICE_NAME" -f -n 20 ;;
        6) sync_ssh ;;
        7) fix_udp_custom ;;
        0) exit 0 ;;
        *) echo -e "\n Pilihan salah!"; sleep 1 ;;
    esac
done
EOF

# 4. Finishing
chmod +x /usr/local/sbin/zivpn-menu
echo -e "\n[OK] Menu terinstall!"
echo -e "Ketik perintah ini untuk membuka menu:"
echo -e ">>> zivpn-menu"
