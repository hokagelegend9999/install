#!/bin/bash
# Simpan sebagai: install-zivpn.sh

# --- ISI LINK DOWNLOAD ZIVPN DI SINI ---
ZIVPN_URL="https://example.com/link-zivpn-core"
# ---------------------------------------

clear
echo "=========================================="
echo "      INSTALLER ZIVPN (ADD-ON)            "
echo "      Otomatis Fix UDP Custom             "
echo "=========================================="

# 1. Input Port ZiVPN
read -p "Masukkan Port untuk ZiVPN (Default: 5667): " ZIVPN_PORT
if [[ -z "$ZIVPN_PORT" ]]; then
    ZIVPN_PORT="5667"
fi

# 2. Download ZiVPN
echo -e "\n[+] Mendownload ZiVPN..."
wget -q -O /usr/bin/zivpn "$ZIVPN_URL"
chmod +x /usr/bin/zivpn

if [ ! -f "/usr/bin/zivpn" ]; then
    echo "ERROR: Link Download ZiVPN mati/salah."
    exit 1
fi

# 3. Buat Service ZiVPN
cat <<EOF > /etc/systemd/system/zivpn.service
[Unit]
Description=ZiVPN Service
After=network.target

[Service]
User=root
Type=simple
ExecStart=/usr/bin/zivpn $ZIVPN_PORT
Restart=always
RestartSec=3s

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable zivpn &>/dev/null
systemctl start zivpn &>/dev/null

echo -e "[OK] ZiVPN terinstall di port $ZIVPN_PORT"

# 4. --- BAGIAN PENTING: AUTO-FIX UDP CUSTOM ---
# Cek apakah UDP Custom terinstall
if [ -f "/etc/systemd/system/udp-custom.service" ]; then
    echo -e "\n[!] Mendeteksi UDP Custom terinstall..."
    echo -e "[+] Menambahkan port $ZIVPN_PORT ke whitelist UDP Custom..."
    
    # Gunakan SED untuk mencari baris ExecStart dan menggantinya
    # Ini akan mengganti exclude lama dengan exclude baru + port zivpn
    sed -i "s/server -exclude .*/server -exclude 22,53,68,$ZIVPN_PORT/g" /etc/systemd/system/udp-custom.service
    
    # Restart UDP Custom agar perubahan efek
    systemctl daemon-reload
    systemctl restart udp-custom
    
    echo -e "[OK] UDP Custom berhasil diupdate agar tidak bentrok."
else
    echo -e "\n[info] UDP Custom tidak ditemukan, melewati auto-fix."
fi

echo -e "\n=========================================="
echo -e " Instalasi Selesai"
echo -e " ZiVPN Port : $ZIVPN_PORT"
echo -e " Status     : Aman berjalan bersama UDP Custom"
echo -e "=========================================="
