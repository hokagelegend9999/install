#!/bin/bash

# --- 1. Install LXC dan dependencies ---
echo "=== Install LXC dan dependencies ==="
apt update
apt install -y lxc lxc-templates bridge-utils iptables

# --- 2. Buat container Ubuntu 20.04 ---
CONTAINER_NAME="legacy-script-env"
UBUNTU_RELEASE="focal"   # Ubuntu 20.04 codename

echo "=== Membuat container Ubuntu 20.04 dengan nama $CONTAINER_NAME ==="
if lxc-info -n $CONTAINER_NAME &>/dev/null; then
  echo "Container $CONTAINER_NAME sudah ada, tidak dibuat ulang."
else
  lxc-create -n $CONTAINER_NAME -t download -- -d ubuntu -r $UBUNTU_RELEASE -a amd64
  echo "Container $CONTAINER_NAME dibuat."
fi

# --- 3. Start container ---
echo "=== Memulai container $CONTAINER_NAME ==="
lxc-start -n $CONTAINER_NAME
sleep 5
lxc-info -n $CONTAINER_NAME

# --- 4. Ambil IP container ---
CONTAINER_IP=$(lxc-info -n $CONTAINER_NAME -iH)
if [ -z "$CONTAINER_IP" ]; then
  echo "Gagal mendapatkan IP container. Pastikan container sudah running."
  exit 1
fi
echo "IP container $CONTAINER_NAME = $CONTAINER_IP"

# --- 5. Aktifkan IP forwarding ---
echo "=== Mengaktifkan IP forwarding ==="
sysctl -w net.ipv4.ip_forward=1

# --- 6. Setup port forwarding dengan iptables ---
echo "=== Setup port forwarding ke $CONTAINER_IP ==="

# Fungsi untuk buat forwarding port
port_forward() {
  local PORT=$1
  local PROTO=$2
  echo "Forwarding $PROTO port $PORT ke $CONTAINER_IP:$PORT"
  iptables -t nat -A PREROUTING -p $PROTO --dport $PORT -j DNAT --to-destination $CONTAINER_IP:$PORT
  iptables -A FORWARD -p $PROTO -d $CONTAINER_IP --dport $PORT -j ACCEPT
}

# Clear aturan lama
iptables -t nat -F PREROUTING
iptables -t nat -F POSTROUTING
iptables -F FORWARD

# Port forwarding list
port_forward 22 tcp         # SSH
port_forward 8080 tcp       # WebSocket Xray (contoh)
port_forward 443 tcp        # Dropbear (contoh)
port_forward 4433 tcp       # SSTP VPN
port_forward 1723 tcp       # PPTP VPN
port_forward 1701 udp       # L2TP VPN
port_forward 6443 tcp       # HAProxy (contoh)

# Atur masquerade agar koneksi balik lancar
iptables -t nat -A POSTROUTING -s $CONTAINER_IP -j MASQUERADE

echo "Port forwarding selesai."

# --- 7. Buat menu masuk container ---
MENU_SCRIPT="/usr/local/bin/menu"

echo "=== Membuat perintah 'menu' untuk masuk container ==="
cat <<EOF > $MENU_SCRIPT
#!/bin/bash
lxc-attach -n $CONTAINER_NAME
EOF

chmod +x $MENU_SCRIPT

echo "Sekarang kamu bisa masuk container dengan perintah: menu"

echo "Setup selesai."
