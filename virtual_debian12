#!/bin/bash
# ================================================
# AUTO INSTALL LXD + UBUNTU 20.04 CONTAINER
# DEBIAN 12 COMPATIBLE
# ================================================

# Hentikan script jika ada error
set -e

# --- [1] INSTALL LXD ---
echo "🛠  INSTALLING LXD..."
sudo apt update
sudo apt install -y snapd
sudo snap install lxd --channel=5.0/stable

# Inisialisasi LXD (non-interactive)
echo "🔧 Initializing LXD..."
sudo lxd init --auto --storage-backend=dir --network-address=0.0.0.0 --network-port=8443 --trust-password=password

# Tambahkan user ke grup lxd
sudo usermod -aG lxd $USER
newgrp lxd <<EONG
echo "🐳 LXD ready: $(lxc --version)"
EONG

# --- [2] BUAT CONTAINER UBUNTU 20.04 ---
echo "🛠  Creating Ubuntu 20.04 container..."
lxc launch ubuntu:20.04 ubuntu20

# --- [3] KONFIGURASI DASAR ---
echo "⚙️  Basic container setup..."
lxc exec ubuntu20 -- bash -c "echo -e 'nameserver 8.8.8.8\nnameserver 1.1.1.1' > /etc/resolv.conf"
lxc exec ubuntu20 -- apt update
lxc exec ubuntu20 -- apt upgrade -y
lxc exec ubuntu20 -- apt install -y sudo curl wget nano net-tools

# --- [4] PORT FORWARDING ---
echo "🔌 Setting up port forwarding..."
lxc profile create tunnel 2>/dev/null || true

# SSH & Dropbear
lxc profile device add tunnel ssh proxy listen=tcp:0.0.0.0:22 connect=tcp:127.0.0.1:22
lxc profile device add tunnel dropbear proxy listen=tcp:0.0.0.0:222 connect=tcp:127.0.0.1:222

# Websocket/Xray
lxc profile device add tunnel ws-http proxy listen=tcp:0.0.0.0:80 connect=tcp:127.0.0.1:80
lxc profile device add tunnel ws-https proxy listen=tcp:0.0.0.0:443 connect=tcp:127.0.0.1:443

# VPN Ports
lxc profile device add tunnel sstp proxy listen=tcp:0.0.0.0:5555 connect=tcp:127.0.0.1:5555
lxc profile device add tunnel pptp proxy listen=tcp:0.0.0.0:1723 connect=tcp:127.0.0.1:1723
lxc profile device add tunnel l2tp1 proxy listen=udp:0.0.0.0:1701 connect=udp:127.0.0.1:1701
lxc profile device add tunnel l2tp2 proxy listen=udp:0.0.0.0:500 connect=udp:127.0.0.1:500
lxc profile device add tunnel l2tp3 proxy listen=udp:0.0.0.0:4500 connect=udp:127.0.0.1:4500

lxc profile add ubuntu20 tunnel

# --- [5] BUAT USER ADMIN ---
echo "👤 Creating admin user..."
lxc exec ubuntu20 -- bash -c "useradd -m -s /bin/bash admin && echo 'admin:password' | chpasswd && usermod -aG sudo admin"

# --- [6] BUAT SHORTCUT 'menu' ---
echo "🔧 Creating 'menu' shortcut..."
sudo tee /usr/local/bin/menu > /dev/null <<'EOF'
#!/bin/bash
clear
echo "🖥  Connecting to Ubuntu 20.04 container..."
echo "🔑 Use password 'password' for admin user"
lxc exec ubuntu20 -- sudo --login --user admin
EOF

sudo chmod +x /usr/local/bin/menu

# --- [7] SELESAI ---
cat <<EOF

✅ INSTALASI SELESAI!

🔹 Akses container:
   - CLI: ketik 'menu'
   - SSH: ssh admin@[IP-HOST] -p 22 (password: password)

🔹 Port yang tersedia:
   - SSH: 22, 222
   - Websocket: 80, 443
   - SSTP: 5555
   - PPTP: 1723
   - L2TP: 1701/udp, 500/udp, 4500/udp

🔥 Tips:
- Untuk install service di container:
  1. Ketik 'menu' untuk masuk
  2. Install paket yang dibutuhkan:
     sudo apt install -y nginx dropbear xray
EOF
