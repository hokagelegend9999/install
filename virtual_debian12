#!/bin/bash

# === CEK HAK AKSES ROOT ===
if [ "$(id -u)" -ne 0 ]; then
  echo "‚ùå Harap jalankan script ini sebagai root (sudo)"
  exit 1
fi

# === KONFIGURASI DASAR ===
CONTAINER="legacy-script-env"
CONTAINER_IMAGE=${1:-"ubuntu/20.04"}  # Bisa diganti jadi debian/12 misalnya

echo "[*] Menggunakan image container: $CONTAINER_IMAGE"

# === CEK LXD TERINSTAL ===
if ! command -v lxc >/dev/null 2>&1; then
  echo "[*] LXD belum terinstal. Menginstal dari APT..."

  apt update
  apt install -y gnupg2 curl lsb-release

  curl -fsSL https://pkgs.zabbly.com/key.asc | gpg --dearmor -o /usr/share/keyrings/zabbly-archive-keyring.gpg
  echo "deb [signed-by=/usr/share/keyrings/zabbly-archive-keyring.gpg] https://pkgs.zabbly.com/lxd $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/lxd.list

  apt update
  apt install -y lxd
fi

# === INISIALISASI LXD ===
echo "[*] Inisialisasi LXD jika belum ada..."
lxd waitready
lxd init --auto

# === CEK APAKAH CONTAINER SUDAH ADA ===
if lxc list "$CONTAINER" >/dev/null 2>&1; then
  echo "‚ö†Ô∏è Container '$CONTAINER' sudah ada. Lewati pembuatan."
else
  echo "[*] Membuat container '$CONTAINER'..."
  lxc launch images:"$CONTAINER_IMAGE" "$CONTAINER"
fi

# === TUNGGU CONTAINER SIAP ===
echo "[*] Menunggu container aktif..."
sleep 10

# === INSTALL DEPENDENSI DI DALAM CONTAINER ===
echo "[*] Instalasi software dalam container..."
lxc exec "$CONTAINER" -- bash -c "
  apt update && apt upgrade -y &&
  apt install -y python2 gcc make curl wget unzip zip screen gnupg net-tools iproute2 iptables nginx dropbear cron htop iftop rsyslog bzip2 gzip dos2unix nano vim mc git cmake libreadline-dev zlib1g-dev libssl-dev libsqlite3-dev libxml-parser-perl python3 python3-pip ruby jq bc
"

# === AUTO RUN MENU ===
echo "[*] Menambahkan auto-run menu dalam container..."
lxc exec "$CONTAINER" -- bash -c "
cat >> /root/.bashrc <<'EOF'

# Auto-run menu jika file ada dan executable
if [ -x /usr/local/sbin/menu ]; then
  /usr/local/sbin/menu
fi
EOF
"

# === ALIAS GLOBAL MENU ===
if ! grep -q "alias menu=" /etc/bash.bashrc; then
  echo "alias menu='lxc exec $CONTAINER -- bash'" >> /etc/bash.bashrc
  echo "‚úÖ Alias global 'menu' ditambahkan ke /etc/bash.bashrc"
else
  echo "‚ÑπÔ∏è Alias 'menu' sudah ada di /etc/bash.bashrc"
fi

# === AMBIL IP CONTAINER ===
echo "[*] Mengambil IP container..."
sleep 5
CONTAINER_IP=$(lxc list "$CONTAINER" -c 4 --format csv | grep -oP '\d+\.\d+\.\d+\.\d+')

if [ -z "$CONTAINER_IP" ]; then
  echo "‚ö†Ô∏è Gagal mendapatkan IP container $CONTAINER"
else
  echo "[*] IP container $CONTAINER adalah $CONTAINER_IP"
fi

# === AMBIL SCRIPT PORT FORWARDING ===
echo "[*] Mengunduh dan menjalankan script port forwarding..."
curl -fsSL https://raw.githubusercontent.com/hokagelegend9999/install/refs/heads/main/port.sh -o /tmp/port.sh

if [ ! -f /tmp/port.sh ]; then
  echo "‚ùå Gagal mengunduh port forwarding script!"
  exit 1
fi

chmod +x /tmp/port.sh
export CONTAINER="$CONTAINER"
export CONTAINER_IP="$CONTAINER_IP"
bash /tmp/port.sh

# === SELESAI ===
echo ""
echo "‚úÖ Selesai! Container '$CONTAINER' siap digunakan."
echo "‚û°Ô∏è Ketik perintah 'menu' dari terminal manapun untuk masuk ke dalam container."
echo "üß† Logout & login ulang agar grup lxd aktif (jika kamu baru menginstalnya)."
