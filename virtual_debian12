#!/bin/bash

# ====================================================
# AUTO-INSTALL DOCKER + UBUNTU CONTAINER + MENU ACCESS
# DEBIAN 12 COMPATIBLE
# ====================================================

# Hentikan script jika ada error
set -e

# --- [1] INSTALL DOCKER ---
echo "🛠  INSTALLING DOCKER..."
sudo apt update
sudo apt install -y ca-certificates curl gnupg

# Tambahkan repo Docker
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install Docker
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Tambahkan user ke grup docker
sudo usermod -aG docker $USER
newgrp docker <<EONG
echo "🐳 Docker siap! Versi: $(docker --version)"
EONG

# --- [2] BUAT CONTAINER ---
echo "🛠  MEMBUAT CONTAINER UBUNTU 20.04..."
docker run -d \
  --name ubuntu20 \
  -p 80:80 \
  -p 443:443 \
  -p 2222:22 \
  -p 3306:3306 \
  -p 5432:5432 \
  -p 8000-8010:8000-8010 \
  ubuntu:20.04 \
  sleep infinity

# --- [3] SETUP CONTAINER ---
echo "⚙️  SETUP DASAR CONTAINER..."
docker exec ubuntu20 apt update
docker exec ubuntu20 apt install -y sudo curl nano bash

# --- [4] BUAT SHORTCUT 'menu' ---
echo "🔧 MEMBUAT PERINTAH 'menu'..."
sudo tee /usr/local/bin/menu > /dev/null <<'EOF'
#!/bin/bash
CONTAINER_NAME="ubuntu20"
if ! docker ps | grep -q $CONTAINER_NAME; then
  echo "🚀 Starting container..."
  docker start $CONTAINER_NAME > /dev/null
fi
docker exec -it $CONTAINER_NAME bash
EOF

sudo chmod +x /usr/local/bin/menu

# --- [5] SELESAI ---
cat <<EOF

✅ SCRIPT SELESAI DIJALANKAN!

Fitur yang telah diaktifkan:
1. Docker terinstall ($(docker --version | cut -d' ' -f3-))
2. Container 'ubuntu20' berjalan
3. Port yang diforward:
   - HTTP:80, HTTPS:443
   - SSH:2222 (akses dengan 'ssh -p 2222 user@host')
   - Database: 3306 (MySQL), 5432 (PostgreSQL)
   - Aplikasi: 8000-8010
4. Akses cepat: ketik 'menu' untuk masuk container

🔥 TIPS:
- Tambahkan user di container: 
  'sudo useradd -m -s /bin/bash username'
- Install aplikasi di container: 
  'sudo apt install -y apache2 mysql-server'
EOF
