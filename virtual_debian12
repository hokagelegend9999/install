#!/bin/bash

# Cek apakah sudah root
if [ "$(id -u)" -ne 0 ]; then
  echo "‚ùå Harap jalankan script ini sebagai root (sudo)"
  exit 1
fi

# === KONFIGURASI ===
CONTAINER="legacy-script-env"
CONTAINER_IMAGE=${1:-"ubuntu:20.04"}  # Bisa juga: debian:12

echo "[*] Menggunakan image container: $CONTAINER_IMAGE"

echo "[*] Update & install Snap (jika belum)..."
apt update && apt install -y snapd

echo "[*] Aktifkan Snap daemon..."
systemctl enable --now snapd
sleep 5

echo "[*] Install LXD via Snap jika belum ada..."
if ! snap list | grep -q lxd; then
  snap install lxd
fi

echo "[*] Tambahkan user '$SUDO_USER' ke grup lxd..."
usermod -aG lxd "$SUDO_USER"

echo "[*] Inisialisasi LXD (otomatis, jika belum)..."
lxd waitready
lxd init --auto

echo "[*] Membuat container '$CONTAINER' dengan image '$CONTAINER_IMAGE'..."
lxc launch images:"$CONTAINER_IMAGE" "$CONTAINER"

echo "[*] Menunggu container aktif..."
sleep 10

echo "[*] Menyiapkan dependensi di dalam container..."
lxc exec "$CONTAINER" -- bash -c "
  apt update && apt upgrade -y &&
  apt install -y python2 gcc make curl wget unzip zip screen gnupg net-tools iproute2 iptables nginx dropbear cron htop iftop rsyslog bzip2 gzip dos2unix nano vim mc git cmake libreadline-dev zlib1g-dev libssl-dev libsqlite3-dev libxml-parser-perl python3 python3-pip ruby jq bc
"

echo "[*] Menambahkan auto-run 'menu' ke dalam /root/.bashrc container..."
lxc exec "$CONTAINER" -- bash -c "
cat >> /root/.bashrc <<'EOF'

# Auto-run menu jika file ada dan executable
if [ -x /usr/local/sbin/menu ]; then
  /usr/local/sbin/menu
fi
EOF
"

echo "[*] Menambahkan alias global 'menu'..."
if ! grep -q "alias menu=" /etc/bash.bashrc; then
  echo "alias menu='lxc exec $CONTAINER -- bash'" >> /etc/bash.bashrc
  echo "‚úÖ Alias global 'menu' ditambahkan ke /etc/bash.bashrc"
else
  echo "‚ÑπÔ∏è Alias 'menu' sudah ada di /etc/bash.bashrc"
fi

echo "[*] Mengambil IP container..."
sleep 5
CONTAINER_IP=$(lxc list "$CONTAINER" -c 4 --format csv | grep -oP '\d+\.\d+\.\d+\.\d+')

if [ -z "$CONTAINER_IP" ]; then
  echo "‚ö†Ô∏è Gagal mendapatkan IP container $CONTAINER"
else
  echo "[*] IP container $CONTAINER adalah $CONTAINER_IP"
fi

echo "[*] Mengunduh dan menjalankan script port forwarding..."
curl -fsSL https://raw.githubusercontent.com/hokagelegend9999/install/refs/heads/main/port.sh -o /tmp/port.sh

if [ ! -f /tmp/port.sh ]; then
  echo "‚ùå Gagal mengunduh port forwarding script!"
  exit 1
fi

chmod +x /tmp/port.sh
export CONTAINER="$CONTAINER"
export CONTAINER_IP="$CONTAINER_IP"
bash /tmp/port.sh

echo ""
echo "‚úÖ Selesai! Container '$CONTAINER' siap digunakan."
echo "‚û°Ô∏è Ketik perintah 'menu' dari terminal manapun untuk masuk ke dalam container."
echo "üß† Logout & login ulang agar grup 'lxd' aktif."
