#!/bin/bash
# ================================================
# FIXED LXD INSTALLATION SCRIPT FOR DEBIAN 12
# ================================================

# --- [1] HAPUS SNAP LAMA ---
echo "ğŸ§¹ Membersihkan snap yang bermasalah..."
sudo systemctl stop snapd
sudo apt purge -y snapd
sudo rm -rf /var/snap /snap /var/lib/snapd

# --- [2] INSTALL SNAP YANG FRESH ---
echo "ğŸ”„ Menginstall ulang snapd..."
sudo apt update
sudo apt install -y snapd
sudo systemctl start snapd
sudo systemctl enable snapd

# --- [3] UPDATE SNAPD ---
echo "ğŸ†™ Memperbarui snapd core..."
while ! sudo snap install core; do
    echo "âš ï¸ Gagal install core, mencoba lagi..."
    sleep 5
done
sudo snap refresh core

# --- [4] INSTALL LXD ---
echo "ğŸ³ Menginstall LXD..."
while ! sudo snap install lxd --channel=5.0/stable; do
    echo "âš ï¸ Gagal install LXD, mencoba lagi..."
    sleep 5
done
sudo snap refresh lxd --channel=5.0/stable

# --- [5] INISIALISASI LXD ---
echo "ğŸ”§ Inisialisasi LXD..."
sudo lxd waitready
sleep 10  # Beri waktu tambahan untuk memastikan service ready
sudo lxd init --auto --storage-backend=dir

# Pastikan socket LXD ada
echo "ğŸ” Memverifikasi socket LXD..."
if [ ! -S /var/snap/lxd/common/lxd/unix.socket ]; then
    echo "âš ï¸ Socket LXD tidak ditemukan, restarting service..."
    sudo snap restart lxd
    sleep 10
fi

# --- [6] KONFIGURASI USER ---
echo "ğŸ‘¤ Konfigurasi user..."
sudo usermod -aG lxd $USER
newgrp lxd <<EONG
echo "âœ… LXD siap digunakan"
lxc list
EONG

# --- [7] VERIFIKASI ---
echo "ğŸ” Verifikasi instalasi..."
sudo lxc info
lxc list

# --- [8] BUAT CONTAINER ---
echo "ğŸš€ Membuat container Ubuntu 20.04..."
while ! lxc launch ubuntu:20.04 ubuntu20; do
    echo "âš ï¸ Gagal membuat container, mencoba lagi..."
    sleep 5
done

lxc exec ubuntu20 -- apt update && lxc exec ubuntu20 -- apt upgrade -y

cat <<EOF

âœ… INSTALASI BERHASIL!

Gunakan perintah berikut:
- Akses container: lxc exec ubuntu20 -- bash
- Cek status: lxc list
- Stop container: lxc stop ubuntu20
EOF
