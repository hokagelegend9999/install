#!/bin/bash

# ====================================================
# AUTO-INSTALL LXD + UBUNTU CONTAINER + PORT FORWARDING
# DEBIAN 12 COMPATIBLE
# ====================================================

# Hentikan script jika ada error
set -e

# --- [1] INSTALL LXD ---
echo "🛠  INSTALLING LXD..."
sudo apt update
sudo apt install -y lxd lxd-client

# Inisialisasi LXD (non-interactive)
echo "🔧 Initializing LXD..."
sudo lxd init --auto --storage-backend=dir

# Tambahkan user ke grup lxd
sudo usermod -aG lxd $USER
newgrp lxd <<EONG
echo "🐳 LXD ready: $(lxc --version)"
EONG

# --- [2] BUAT CONTAINER ---
echo "🛠  MEMBUAT CONTAINER UBUNTU 20.04..."
lxc launch ubuntu:20.04 ubuntu20

# --- [3] SETUP DASAR ---
echo "⚙️  SETUP DASAR CONTAINER..."
lxc exec ubuntu20 -- apt update
lxc exec ubuntu20 -- apt install -y sudo curl nano bash openssh-server

# --- [4] PORT FORWARDING ---
echo "🔌 SETUP PORT FORWARDING..."
# Buat profile khusus
lxc profile create portforwarding
lxc profile device add portforwarding hostport proxy \
  listen=tcp:0.0.0.0:80 connect=tcp:127.0.0.1:80
lxc profile device add portforwarding hostport-ssh proxy \
  listen=tcp:0.0.0.0:2222 connect=tcp:127.0.0.1:22

# Terapkan profile ke container
lxc profile add ubuntu20 portforwarding

# --- [5] BUAT SHORTCUT 'menu' ---
echo "🔧 MEMBUAT PERINTAH 'menu'..."
sudo tee /usr/local/bin/menu > /dev/null <<'EOF'
#!/bin/bash
lxc exec ubuntu20 -- bash
EOF

sudo chmod +x /usr/local/bin/menu

# --- [6] SELESAI ---
cat <<EOF

✅ SCRIPT SELESAI DIJALANKAN!

Fitur yang telah diaktifkan:
1. LXD terinstall ($(lxc --version))
2. Container 'ubuntu20' berjalan
3. Port yang diforward:
   - HTTP:80 → container:80
   - SSH:2222 → container:22
4. Akses cepat: ketik 'menu' untuk masuk container

🔥 TIPS:
- Akses SSH dari host: 
  'ssh ubuntu@localhost -p 2222'
- Tambahkan port forwarding baru:
  'lxc profile device add portforwarding nama-device proxy \\
   listen=tcp:0.0.0.0:<HOST_PORT> connect=tcp:127.0.0.1:<CONTAINER_PORT>'
EOF
